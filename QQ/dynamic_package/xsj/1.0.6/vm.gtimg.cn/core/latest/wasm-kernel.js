/*!
 * thumbplayer-h5
 * Update Date: 2024-04-29 18:11:59
 * Author: thumbplayer-h5 team
 * ---
 * Copyright (c) 2024 Tencent
 */
window.ThumbPlayerKernelWasm=function(e){var t={};function i(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(r,s,function(t){return e[t]}.bind(null,s));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=8)}([function(e,t){e.exports=window.ThumbPlayerCore},function(e,t,i){
  /*!
   * thumbplayer-h5
   * Update Date: 2024-04-11 19:30:06
   * Author: thumbplayer-h5 team
   * ---
   * Copyright (c) 2024 Tencent
   */
  e.exports=function(e){var t={};function i(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(r,s,function(t){return e[t]}.bind(null,s));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=2)}([function(e,t,i){
  /*!
   * thumbplayer-h5
   * Update Date: 2024-04-11 19:30:03
   * Author: thumbplayer-h5 team
   * ---
   * Copyright (c) 2024 Tencent
   */
  e.exports=function(e){var t={};function i(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(r,s,function(t){return e[t]}.bind(null,s));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=5)}([function(e,t,i){"use strict";i.d(t,"a",(function(){return h})),i.d(t,"j",(function(){return d})),i.d(t,"l",(function(){return c})),i.d(t,"h",(function(){return _})),i.d(t,"i",(function(){return f})),i.d(t,"m",(function(){return m})),i.d(t,"c",(function(){return r})),i.d(t,"d",(function(){return s})),i.d(t,"e",(function(){return n})),i.d(t,"g",(function(){return a})),i.d(t,"f",(function(){return o})),i.d(t,"k",(function(){return l})),i.d(t,"b",(function(){return u}));const r={5002:"AAC",172:"HEVC",26:"H.264",193:"VVC"};var s,n;!function(e){e.UNKNOWN="70060000",e.LOAD_WASM_MAIN_SCRIPT="70060001",e.LOAD_WASM_SPWAN_WORKER_SCRIPT="70060002",e.NOT_SUPPROT="70060003",e.LOAD_WASM="70060004",e.NET_UNABLE="70060005",e.NET_STATUS_CODE="70060006",e.RUNTIME="70060007",e.LOAD_IFRAME="70060008",e.FILE_SIZE="70060009"}(s||(s={})),function(e){e.UNKNOWN="鏈煡閿欒",e.LOAD_WASM_SCRIPT="鍐呮牳鏂囦欢鍔犺浇澶辫触",e.NOT_SUPPROT="涓嶆敮鎸佹挱鏀�",e.NOT_SUPPROT_HTTP="鎶辨瓑锛屾挱鏀鹃〉闈㈤渶瑕乭ttps鍗忚",e.NOT_SUPPROT_SAB="鎶辨瓑锛屾偍鐨勬祻瑙堝櫒缂哄皯蹇呰鎺ュ彛锛圫AB锛�",e.NOT_SUPPROT_WASM="鎶辨瓑锛屾偍鐨勬祻瑙堝櫒缂哄皯蹇呰鎺ュ彛锛圵ASM锛�",e.NET_UNABLE="瑙嗛鑾峰彇閫斾腑鍑虹幇闂",e.NET_STATUS="瑙嗛鑾峰彇閫斾腑鍑虹幇閿欒",e.PLAY_CORE_ERR="鍐呮牳鍙戠敓閿欒",e.FILE_SIZE="鑾峰彇瑙嗛澶у皬澶辫触"}(n||(n={}));const a={getNotSptErrMsg:e=>e&&/^http:/.test(e)?n.NOT_SUPPROT_HTTP:window.SharedArrayBuffer?window.WebAssembly?n.NOT_SUPPROT:n.NOT_SUPPROT_WASM:n.NOT_SUPPROT_SAB,getTimeRangeErrorMsg:(e,t,i)=>`Failed to execute '${e}' on 'TimeRanges': The index provided (${i}) is greater than the maximum bound (${t}).`,getApiNotSptErrorMsg:e=>`not support ${e} right now.`,BLOCK_ERROR_MSG:"NotAllowedError, play() failed because the user didn't interact with the document first.",NULL_SOURCE_ERROR_MSG:"The element has no supported sources.",INVAILD_STATE_ERROR_MSG:"Call in unmatched state"};var o,l,u;!function(e){e.CAPTURE_OVER="captureOver",e.VIDEO_FRAME_RENDER="videoFrameRender",e.STATE_CHANGE="stateChange",e.TIME_UPDATE="timeupdate",e.VOLUME_CHANGE="volumechange",e.RATE_CHANGE="ratechange",e.WAITING="waiting",e.DURATION_CHANGE="durationchange",e.LOADED_METADATA="loadedmetadata",e.CANPLAY="canplay",e.PAUSE="pause",e.PLAYING="playing",e.ENDED="ended",e.PROGRESS="progress",e.SEEKING="seeking",e.SEEKED="seeked",e.ERROR="error"}(o||(o={})),function(e){e[e.PLAYER_API_STATE_IDLE=0]="PLAYER_API_STATE_IDLE",e[e.PLAYER_API_STATE_INITIALIZED=1]="PLAYER_API_STATE_INITIALIZED",e[e.PLAYER_API_STATE_PREPARING=2]="PLAYER_API_STATE_PREPARING",e[e.PLAYER_API_STATE_PREPARED=3]="PLAYER_API_STATE_PREPARED",e[e.PLAYER_API_STATE_STARTED=4]="PLAYER_API_STATE_STARTED",e[e.PLAYER_API_STATE_PAUSED=5]="PLAYER_API_STATE_PAUSED"}(l||(l={})),function(e){e.CALL_WORKER_INIT_WORKER="callWorker_initWorker",e.CALL_WORKER_LOAD="callWorker_load",e.CALL_WORKER_PLAY="callWorker_play",e.CALL_WORKER_SEEK="callWorker_seek",e.CALL_WORKER_SET_RATE="callWorker_setRate",e.CALL_WORKER_PAUSE="callWorker_pause",e.CALL_WORKER_PLAY_AUDIO_FRAME_OK="callWorker_playAudioFrameOk",e.CALL_WORKER_PLAY_VIDEO_FRAME_OK="callWorker_playVideoFrameOk",e.CALL_MAIN_INIT_WORKER_OVER="callMain_initWorkerOver",e.CALL_MAIN_REV_AUDIO_FRAME="callMain_receiveAudioFrame",e.CALL_MAIN_REV_VIDEO_FRAME="callMain_receiveVideoFrame",e.CALL_MAIN_UDPATE_METADATA="callMain_updateMetadata",e.CALL_MAIN_BUFFER_CHANGE="callMain_bufferChange",e.CALL_MAIN_BUFFER_STATE_CHANGE="callMain_bufferStateChange",e.CALL_MAIN_SEEK_STATE_CHANGE="callMain_seekStateChange",e.CALL_MAIN_STATE_CHANGE="callMain_stateChange",e.CALL_MAIN_ERROR="callMain_error",e.CALL_MAIN_ENDED="callMain_ended"}(u||(u={}));const h="https://vm.gtimg.cn/thumbplayer/wasm",d="AlMxYrg5zb0xb8x+vIGEWzQvjCNeiLwmBIGwSGb05mY+6VBEKawkSop+vXFC+p1flYyBgBjFY1nTFFE265ZxVwMAAAB1eyJvcmlnaW4iOiJodHRwczovL3ZtLmd0aW1nLmNuOjQ0MyIsImZlYXR1cmUiOiJVbnJlc3RyaWN0ZWRTaGFyZWRBcnJheUJ1ZmZlciIsImV4cGlyeSI6MTcxOTM1OTk5OSwiaXNTdWJkb21haW4iOnRydWV9",c={min:"e6909cdc42",full:"860077d186",lt:"d7e71c5cf3"},_=3,f=.5,m={featType:"min",openLog:"false",wasmLogLevel:"-1",captureType:"none",closeIndexdb:"false",decoderConcurrency:"3"}},function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return o}));const r=function(){},s={trace:r,debug:r,log:r,warn:r,info:r,error:r};let n=s;function a(e){if(self.console&&!0===e){["debug","log","info","warn","error"].forEach((function(e){n[e]=function(e){return self.console[e]||r}(e)}));try{n.log()}catch(e){n=s}}else n=s}const o=s},function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));const r="object"==typeof Reflect?Reflect:null,s=r&&"function"==typeof r.apply?r.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};let n;function a(...e){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,e)}n=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};class o{constructor(){this._events=Object.create(null),this._eventsCount=0,this._maxListeners=void 0,this._defaultMaxListeners=10}get defaultMaxListeners(){return this._defaultMaxListeners}set defaultMaxListeners(e){this._defaultMaxListeners=e}setMaxListeners(e){if("number"!=typeof e||e<0)throw new RangeError(`The value of "n" is out of range. It must be a non-negative number. Received ${e}.`);return this._maxListeners=e,this}getMaxListeners(){return this._maxListeners}emit(e,...t){const i=this._events;if(void 0===i)return!1;const r=[{type:e,target:this,data:1===t.length?t[0]:t}],n=i[e];if(void 0===n)return!1;if("function"==typeof n)s(n,this,r);else{const e=n,t=e.length,i=[...e];for(let e=0;e<t&&s(i[e],this,r)!==o.STOP_IMMEDIATE_PROPAGATION;++e);}return!0}addListener(e,t){return this._addListener(e,t,!1)}_addListener(e,t,i){let r,s,n=this._events;return void 0===n?(n=Object.create(null),this._events=n,this._eventsCount=0):s=n[e],void 0===s?(s=t,n[e]=t,++this._eventsCount):("function"==typeof s?(n[e]=i?[t,s]:[s,t],s=n[e]):i?s.unshift(t):s.push(t),r=this.getMaxListeners(),r>0&&s.length>r&&!s.warned&&(s.warned=!0,null===console||void 0===console||console.warn(`Possible EventEmitter memory leak detected. ${s.length} ${String(e)} listeners added. Use emitter.setMaxListeners() to increase limit`))),this}on(e,t,i){let r=!0;if("number"==typeof i&&!Number.isNaN(i)){t.priority=i;const s=this.listeners(e);r=!(s&&s.length>0)||s.some(e=>e.priority>i)}return this._addListener(e,t,!r)}listeners(e){const t=this._events;if(void 0===t)return[];const i=t[e];return void 0===i?[]:"function"==typeof i?[i]:[...i]}prependListener(e,t){return this._addListener(e,t,!0)}once(e,t){return this.on(e,function(e,t,i){const r={fired:!1,wrapFn(){},target:e,type:t,listener:i},s=a.bind(r);return s.listener=i,r.wrapFn=s,s}(this,e,t)),this}removeListener(e,t){const i=this._events;if(void 0===i)return this;const r=i[e];if(void 0===r)return this;if(r===t)0==--this._eventsCount?this._events=Object.create(null):delete i[e];else if("function"!=typeof r){const s=r;let n,a;for(n=-1,a=s.length-1;a>=0;a--)if(s[a]===t){n=a;break}if(n<0)return this;0===n?s.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(s,n),1===s.length&&(i[e]=s[0])}return this}off(e,t){this.removeListener(e,t)}removeAllListeners(e){const t=this._events;return void 0===t||(0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==t[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete t[e])),this}listenerCount(e){const t=this._events;if(void 0!==t){const i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}eventNames(){return this._eventsCount>0?n(this._events):[]}}o.STOP_IMMEDIATE_PROPAGATION="EventEmitter.STOP_IMMEDIATE_PROPAGATION"},function(e,t,i){function r(e){var t={};function i(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}i.m=e,i.c=t,i.i=function(e){return e},i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},i.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i.oe=function(e){throw console.error(e),e};var r=i(i.s=ENTRY_MODULE);return r.default||r}function s(e){return(e+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}function n(e,t,r){var n={};n[r]=[];var a=t.toString(),o=a.match(/^function\s?\w*\(\w+,\s*\w+,\s*(\w+)\)/);if(!o)return n;for(var l,u=o[1],h=new RegExp("(\\\\n|\\W)"+s(u)+"\\(\\s*(/\\*.*?\\*/)?\\s*.*?([\\.|\\-|\\+|\\w|/|@]+).*?\\)","g");l=h.exec(a);)"dll-reference"!==l[3]&&n[r].push(l[3]);for(h=new RegExp("\\("+s(u)+'\\("(dll-reference\\s([\\.|\\-|\\+|\\w|/|@]+))"\\)\\)\\(\\s*(/\\*.*?\\*/)?\\s*.*?([\\.|\\-|\\+|\\w|/|@]+).*?\\)',"g");l=h.exec(a);)e[l[2]]||(n[r].push(l[1]),e[l[2]]=i(l[1]).m),n[l[2]]=n[l[2]]||[],n[l[2]].push(l[4]);for(var d,c=Object.keys(n),_=0;_<c.length;_++)for(var f=0;f<n[c[_]].length;f++)d=n[c[_]][f],isNaN(1*d)||(n[c[_]][f]=1*n[c[_]][f]);return n}function a(e){return Object.keys(e).reduce((function(t,i){return t||e[i].length>0}),!1)}e.exports=function(e,t){t=t||{};var s={main:i.m},o=t.all?{main:Object.keys(s.main)}:function(e,t){for(var i={main:[t]},r={main:[]},s={main:{}};a(i);)for(var o=Object.keys(i),l=0;l<o.length;l++){var u=o[l],h=i[u].pop();if(s[u]=s[u]||{},!s[u][h]&&e[u][h]){s[u][h]=!0,r[u]=r[u]||[],r[u].push(h);for(var d=n(e,e[u][h],u),c=Object.keys(d),_=0;_<c.length;_++)i[c[_]]=i[c[_]]||[],i[c[_]]=i[c[_]].concat(d[c[_]])}}return r}(s,e),l="";Object.keys(o).filter((function(e){return"main"!==e})).forEach((function(e){for(var t=0;o[e][t];)t++;o[e].push(t),s[e][t]="(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })",l=l+"var "+e+" = ("+r.toString().replace("ENTRY_MODULE",JSON.stringify(t))+")({"+o[e].map((function(t){return JSON.stringify(t)+": "+s[e][t].toString()})).join(",")+"});\n"})),l=l+"new (("+r.toString().replace("ENTRY_MODULE",JSON.stringify(e))+")({"+o.main.map((function(e){return JSON.stringify(e)+": "+s.main[e].toString()})).join(",")+"}))(self);";var u=new window.Blob([l],{type:"text/javascript"});if(t.bare)return u;var h=(window.URL||window.webkitURL||window.mozURL||window.msURL).createObjectURL(u),d=new window.Worker(h);return d.objectURL=h,d}},function(e,t,i){"use strict";i.r(t),i.d(t,"default",(function(){return O}));var r=i(0),s=i(1),n=i(2);function a(e){const t=e.retryCount||0,i=+new Date;let s=0;const n={promise:null,xhr:null},a=(o,l)=>{const u=new XMLHttpRequest;e.timeout&&(u.timeout=e.timeout),e.responseType&&(u.responseType=e.responseType),u.ontimeout=e.ontimeout,u.open(e.method||"get",e.url),e.range&&u.setRequestHeader("Range",`bytes=${e.range[0]}-${e.range[1]}`),u.onload=()=>{200===u.status||206===u.status?o({data:u.response,target:u,startTimestamp:i,opts:e}):s<t?(s++,a(o,l)):l({message:`${r.e.NET_STATUS}[${u.status}]`,code:r.d.NET_STATUS_CODE,target:u})},u.onerror=e=>{s<t?(s++,a(o,l)):l({message:r.e.NET_UNABLE,code:r.d.NET_UNABLE,target:u})},u.onabort=()=>{},e.body?u.send(e.body):u.send(),n.xhr=u};return n.promise=new Promise((e,t)=>{a(e,t)}),n}function o(e){return a(e).promise}const l="error";class u extends n.a{constructor(e,t){super(),this._destroyed=!1,this._wasmApi=e,this._videoConfig=t}load(e,t){}onRequestNewBufferCallback(e,t=-1,i=0){}destroy(){this._videoConfig=null,this._wasmApi=null,this._destroyed=!0,this.removeAllListeners(),s.b.log("[BaseProvider] Provider has been destroyed")}raiseInnerErr(e,t){this.emit(l,{code:e,message:t})}}class h extends u{load(e,t){const i=a({url:e,retryCount:2,responseType:this.getResponseType()});i.promise.then(e=>{this.onLoadedSucc(t,e.data)}).catch(e=>{this.raiseInnerErr(null==e?void 0:e.code,null==e?void 0:e.message)}),this._xhr=i.xhr}getResponseType(){return"arraybuffer"}onLoadedSucc(e,t){const i=new Uint8Array(t);this.writeBufferToFFmpeg(e,i)}writeBufferToFFmpeg(e,t){if(this._destroyed)return;const i=this._wasmApi.writeArrayBufferToWasm(t),r=t.byteLength,n=this._wasmApi.writeBufferToFFmpeg(e,i,0,r,r);s.b.log("[FileProvider] call Module._writeBuffer, ret: "+n)}destroy(){this._xhr&&(this._xhr.abort(),this._xhr=null),super.destroy()}}class d extends h{getResponseType(){return"text"}load(e,t){var i,r;(null===(i=this._videoConfig)||void 0===i?void 0:i.m3u8Str)?this.onLoadedSucc(t,null===(r=this._videoConfig)||void 0===r?void 0:r.m3u8Str):super.load(e,t)}onLoadedSucc(e,t){const i=t,r=this.replaceProtocol(i);var s;(s=r.trim(),new Promise((function(e){const t=new Blob([s],{type:"text/plain"}),i=new FileReader;i.readAsArrayBuffer(t),i.onload=function(){e(i.result)}}))).then(t=>{const i=new Uint8Array(t);this.writeBufferToFFmpeg(e,i)})}replaceProtocol(e){return e.replace(/(https?)/g,"$1js")}}var c;!function(e){e.START="loadStart",e.PROGRESS="loadProgress",e.END="loadEnd",e.ERROR="error"}(c||(c={}));class _ extends n.a{constructor(){super(...arguments),this.fileSizeInner=0}open(e,t){this.emit(c.START);const{fileSize:i=0,rangeStart:r=0,rangeEnd:n=0,type:a="vod"}=t||{};this.abortCtrl=new AbortController,this.type=a,this.fileSizeInner=!Number.isNaN(i)&&i>0?i:0;const o={};"vod"===a&&r>=0&&(o.Range=`bytes=${r}-${n>0&&n>r?n:""}`),this.fileSizeInner<=0&&"vod"===a?function(e){return new Promise((t,i)=>{const r=new XMLHttpRequest;r.open("GET",e,!0),r.onreadystatechange=function(){if(this.readyState==this.HEADERS_RECEIVED){const e=parseInt(r.getResponseHeader("Content-Length"));r.abort(),t(e)}},r.onerror=function(){i()},r.send()})}(e).then(e=>{this.fileSizeInner=e}).catch(()=>{s.b.log("[FetchLoader] getFileSizeByXhr error")}).finally(()=>{this.doFetch(e,o)}):this.doFetch(e,o)}get fileSize(){return this.fileSizeInner}abort(){var e;null===(e=this.abortCtrl)||void 0===e||e.abort(),this.abortCtrl=null}destroy(){this.abort()}doFetch(e,t){var i;fetch(e,{headers:t,signal:null===(i=this.abortCtrl)||void 0===i?void 0:i.signal}).then(e=>{if(e.ok&&this.fileSizeInner<=0){const t=function(e){let t=0;if(e.has("Content-Range")){try{const i=e.get("Content-Range");t=parseInt(i.match(/\/(\d+)/)[1],10)}catch(e){s.b.log("[getFileSizeFromHeader] can not read Content-Range header because cors.")}return t||0}return t}(e.headers);t>0&&(this.fileSizeInner=t)}return this.fileSizeInner<=0&&"vod"===this.type?(this.abort(),void this.emit(c.ERROR,{message:r.e.FILE_SIZE,code:r.d.FILE_SIZE})):e.ok?e.body:(this.abort(),void this.emit(c.ERROR,{message:`${r.e.NET_STATUS}[${e.status}]`,code:r.d.NET_STATUS_CODE}))}).then(e=>{const t=e.getReader(),i=this.emit.bind(this),r=this.fileSizeInner;return new ReadableStream({start(e){!function n(){t.read().then(({done:t,value:s})=>{if(t)return e.close(),void i(c.END);e.enqueue(s),i(c.PROGRESS,{chunk:s,fileSize:r}),n()}).catch(e=>{s.b.log("[FetchLoader] reader.read() get a error, ",e)})}()}})}).catch(e=>{this.emit(c.ERROR,{message:`鏃犳硶鑾峰彇瑙嗛娴�(${e})`,code:r.d.NET_UNABLE})})}}class f extends n.a{constructor(){super(),this._bufferChunkOffsetIndex=0,this._rangeStartPos=0,this._currentUrl="",this._loader=new _,this._evtMap={[c.PROGRESS]:this.onLoadProgress.bind(this),[c.END]:this.onLoadEnd.bind(this),[c.ERROR]:this.onLoadError.bind(this)}}open(e,t=0,i=0,r="vod"){this.stop(),this.setEvts(!0),this._currentUrl=e,this._bufferChunks=[],this._rangeStartPos=t,this._bufferChunkOffsetIndex=0,this._loader.open(e,{fileSize:i,rangeStart:t,type:r})}stop(){var e;this.setEvts(!1),this._currentUrl="",this._bufferChunks=null,null===(e=this._loader)||void 0===e||e.abort()}get url(){return this._currentUrl}get fileSize(){var e;return(null===(e=this._loader)||void 0===e?void 0:e.fileSize)||0}get bufferChunks(){return this._bufferChunks}get bufferChunkOffsetIndex(){return this._bufferChunkOffsetIndex}set bufferChunkOffsetIndex(e){if(e<0||e>=this._bufferChunks.length)throw new Error(`bufferChunkOffsetIndex out of range [0-${this._bufferChunks.length})`);this._bufferChunkOffsetIndex=e}checkBuffer(e){if(e<=0)return null;if(this._bufferChunkOffsetIndex>=this._bufferChunks.length)return null;let t,i;this.fileSize>0&&(e=Math.min(e,this.fileSize-this._bufferChunks[this._bufferChunkOffsetIndex].startPosOnFile));let r=0,s=0,n=!1;for(t=this._bufferChunkOffsetIndex,i=this._bufferChunks.length;t<i;t++)if(r+=this._bufferChunks[t].bufferLength,s++,r>=e){n=!0;break}return n?{spliceChunkCount:s,totalChunkSize:r}:null}readBuffer(e,t){let i,r;const s=new Uint8Array(e);let n=0;const a=this._bufferChunks.slice(this._bufferChunkOffsetIndex,this._bufferChunkOffsetIndex+t);for(i=0,r=a.length;i<r;i++)s.set(a[i].buffer,n),n+=a[i].bufferLength;return this._bufferChunkOffsetIndex+=t,s}checkPosHasBuffered(e){const t={bufferChunkOffsetIndex:-1};let i,r;if(e<this._rangeStartPos||e>=this.fileSize)return t;for(i=0,r=this._bufferChunks.length;i<r;i++){const r=this._bufferChunks[i];if(r.buffer&&e>=r.startPosOnFile&&e<r.startPosOnFile+r.bufferLength){t.bufferChunkOffsetIndex=i;break}}return t}destroy(){this.removeAllListeners(),this.stop()}setEvts(e){this._loader&&Object.keys(this._evtMap).forEach(t=>{e?this._loader.on(t,this._evtMap[t]):this._loader.off(t,this._evtMap[t])})}onLoadProgress(e){const{chunk:t}=e.data,i=this._bufferChunks[this._bufferChunks.length-1],r={buffer:t,bufferLength:t.length,startPosOnFile:i?i.startPosOnFile+i.bufferLength:this._rangeStartPos};this._bufferChunks.push(r),this.emit(c.PROGRESS)}onLoadEnd(e){this.emit(c.END)}onLoadError(e){this.emit(c.ERROR,e.data)}}class m extends u{constructor(e,t){var i;super(e,t),this._needSendWasmBuffer=!0,this._sendChunkSize=0,this._sendChunkSize="vod"===(null===(i=this._videoConfig)||void 0===i?void 0:i.type)?1048576:262144}load(e,t){var i,r;this._streamLoader&&(this._streamLoader.destroy(),this._streamLoader=null),this._streamLoader=new f,this._streamLoader.on(c.PROGRESS,()=>{this.sendPartBufferToWasm(t)}),this._streamLoader.on(c.END,()=>{s.b.log("[FileProvider] streamLoader has been loaded, the url is "+e)}),this._streamLoader.on(c.ERROR,e=>{var t,i;this.raiseInnerErr(null===(t=e.data)||void 0===t?void 0:t.code,null===(i=e.data)||void 0===i?void 0:i.message)}),this._streamLoader.open(e,0,(null===(i=this._videoConfig)||void 0===i?void 0:i.fileSize)||0,(null===(r=this._videoConfig)||void 0===r?void 0:r.type)||"vod")}onRequestNewBufferCallback(e,t=-1,i=0){if(s.b.log(`[FileProvider] onRequestNewBufferCallback: filenamePtr=0x${e.toString(16)}, seekPosOnFile=`+t),this._needSendWasmBuffer=!0,1!==i)if(-1===t)this.sendPartBufferToWasm(e);else{const{bufferChunkOffsetIndex:i}=this._streamLoader.checkPosHasBuffered(t);-1!==i?(s.b.log("[FileProvider] onRequestNewBufferCallback::: case 1, in bufferbufferChunkOffsetIndex="+i),this._streamLoader.bufferChunkOffsetIndex=i,this.sendPartBufferToWasm(e)):(s.b.log("[FileProvider] onRequestNewBufferCallback::: case 2, out of buffer="),this.reconnect(t))}else this.reconnect(t)}destroy(){this._streamLoader&&(this._streamLoader.destroy(),this._streamLoader=null),super.destroy()}reconnect(e){var t,i;this._streamLoader.open(this._streamLoader.url,e,(null===(t=this._videoConfig)||void 0===t?void 0:t.fileSize)||0,(null===(i=this._videoConfig)||void 0===i?void 0:i.type)||"vod")}sendPartBufferToWasm(e){if(this._destroyed||!this._needSendWasmBuffer)return;const{spliceChunkCount:t=0,totalChunkSize:i}=this._streamLoader.checkBuffer(this._sendChunkSize)||{};if(t<=0)return;const r=this._streamLoader.bufferChunks[this._streamLoader.bufferChunkOffsetIndex].startPosOnFile,n=this._streamLoader.readBuffer(i,t),a=this._wasmApi.writeArrayBufferToWasm(n);this._streamLoader.fileSize>0&&(this._videoConfig.fileSize=this._streamLoader.fileSize),s.b.log(`[FileProvider] call Module._writeBuffer, offsetOnFile=${r}, bufferLen=${n.byteLength}, fileSize=${this._streamLoader.fileSize}`);const o=this._wasmApi.writeBufferToFFmpeg(e,a,r,n.byteLength,this._streamLoader.fileSize);s.b.log("[FileProvider] call Module._writeBuffer, ret: "+o),0===o&&(this._needSendWasmBuffer=!1)}}var p=function(e,t,i,r){return new(i||(i=Promise))((function(s,n){function a(e){try{l(r.next(e))}catch(e){n(e)}}function o(e){try{l(r.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}l((r=r.apply(e,t||[])).next())}))};class E extends h{onLoadedSucc(e,t){var i;let r;r=(null===(i=this._videoConfig)||void 0===i?void 0:i.decConfig)?this.tryDecChacha20(t):Promise.resolve(new Uint8Array(t)),r.then(t=>{super.writeBufferToFFmpeg(e,t)})}tryDecChacha20(e){return p(this,void 0,void 0,(function*(){const t=new Uint8Array(e);let i,r=0,s=0;for(;!(s>=t.byteLength);){const e=Math.min(t.byteLength,1024+s),n=t.slice(s,e);s=e;const a=this.decChunk(n),{buf:o,ptr:l}=a,u=i?i.length:0,h=i;i=new Uint8Array(u+o.byteLength),h&&i.set(h,0),i.set(o,u),this._wasmApi.freePtr(l),r++,r%100==0&&(yield this.waitNextFrame())}return i}))}waitNextFrame(){return p(this,void 0,void 0,(function*(){return new Promise(e=>{setTimeout(e,0)})}))}decChunk(e){const t=e.byteLength,i=this._wasmApi.malloc(t),r=this._wasmApi.malloc(t);this._wasmApi.heapU8.set(e,r),this._wasmApi.decData(i,r,t);const s=this._wasmApi.heapU8.slice(i,i+t);return this._wasmApi.freePtr(r),{buf:s,ptr:i}}}class g{static cdnUrl2ffmpegUrl(e){return e.replace(/^(blob:)?(https):\/\//,"$2js://$1")}static ffmpegUrl2CdnUrl(e){return e.replace(/^(https?)js:\/\/(blob:)?/,"$2$1://")}}class A extends n.a{constructor(e,t){super(),this._wasmApi=e,this._videoConfig=t,this._providerMap={}}httpjsOpenCallback(e){const t=this.getUrlFromPtr(e);s.b.log("[HttpjsProtocol(js)] httpjsOpenCallback: ",t),this.createProvider(t,this._videoConfig).load(t,e)}httpjsCloseCallback(e){const t=this.getUrlFromPtr(e);s.b.log("[HttpjsProtocol(js)] httpjsCloseCallback: ",t);const i=this._providerMap[t];i&&(i.destroy(),delete this._providerMap[t])}onRequestNewBufferCallback(e,t=-1,i=0){const r=this.getUrlFromPtr(e),s=this._providerMap[r];s&&s.onRequestNewBufferCallback(e,t,i)}getUrlFromPtr(e){const t=this._wasmApi.getStringFromWasm(e);return g.ffmpegUrl2CdnUrl(t)}createProvider(e,t){this._providerMap[e]&&(this._providerMap[e].destroy(),delete this._providerMap[e]);const i=function(e){if(!e)return null;const t=function(e){if(!e)return null;let t=e;const i=t.indexOf("?");i>0&&(t=t.slice(0,i));const r=t.lastIndexOf("/");return r>0&&(t=t.slice(r+1,t.length)),t}(e);if(t){const e=t.split(".");if(e&&e.length>1)return e[e.length-1]}return null}(e),r=new({m3u8:d,ts:E}[i]||m)(this._wasmApi,t);return r.on(l,this.onProviderEvts.bind(this)),this._providerMap[e]=r,r}onProviderEvts(e){this.emit(e.type,e.data)}freeProviders(){this._providerMap&&Object.keys(this._providerMap).forEach(e=>{this._providerMap[e].destroy()}),this._providerMap={}}destroy(){this.freeProviders(),this.removeAllListeners()}}class v{constructor(e,t){this._selfAlias=e,this.config=t,this._mainLoopTimerID=0,this._bufferedDuraionMs=0,this._videoStateInCpp=r.k.PLAYER_API_STATE_IDLE,this.initGlobalCallByCpp()}prepareDecParams(e,t){const{linkvid:i}=e,r=i?"vod":"live";if("vod"===r){const{linkvid:t,base:i,appVer:r,tm:s,platform:n}=e,a=this.writeStringToWasm(t),o=this.writeStringToWasm(i),l=this.writeStringToWasm(r);return this._selfAlias.Module._prepareDecParams(a,o,l,s,n),this.freePtr(a),this.freePtr(o),void this.freePtr(l)}if("live"===r){const{cnlid:t,baseKey:i,randoms:r}=e,s=this.writeStringToWasm(t),n=this.writeStringToWasm(i),a=this.writeStringToWasm(r);this._selfAlias.Module._prepareLiveDecParams(s,n,a),this.freePtr(s),this.freePtr(n),this.freePtr(a)}}decData(e,t,i){this._selfAlias.Module._decData(e,t,i)}seek(e){this._selfAlias.Module._seekVideo(1e3*e)}setRate(e){this._selfAlias.Module._setRate(e)}pause(){this._selfAlias.Module._pauseVideo()}play(e){const t=this._selfAlias.Module._playVideo();return+e>0&&this.setRate(e),t}load(e){if(s.b.log("[WasmCppBridge] call load, videoConfig=",e),!e||!e.url)return this._selfAlias.Module._loadVideo(),void this.resetPlayer();const{url:t,startTimeMs:i,decConfig:r,type:n}=e;this.setMainLoopTimer(!0),this.createProtocol(e),r&&this.prepareDecParams(r,n);const a=g.cdnUrl2ffmpegUrl(t),o=this.writeStringToWasm(a);this._selfAlias.Module._setVideoDecoderThread(Number(this.config.decoderConcurrency)),this._selfAlias.Module._loadVideo(o,i)}playAudioFrameOk(){this._selfAlias.Module._unlockReadAudioFrame()}playVideoFrameOk(){this._selfAlias.Module._unlockReadVideoFrame()}getBufferedDurationMs(){return this._selfAlias.Module._getBufferedDurationMs()}writeStringToWasm(e){if(!e)return-1;const t=4*e.length+4,i=this._selfAlias.Module._malloc(t);return function(e,t,i,r){if(!(r>0))return 0;const s=i+r-1;for(let r=0;r<e.length;++r){let n=e.charCodeAt(r);if(n>=55296&&n<=57343&&(n=65536+((1023&n)<<10)|1023&e.charCodeAt(++r)),n<=127){if(i>=s)break;t[i++]=n}else if(n<=2047){if(i+1>=s)break;t[i++]=192|n>>6,t[i++]=128|63&n}else if(n<=65535){if(i+2>=s)break;t[i++]=224|n>>12,t[i++]=128|n>>6&63,t[i++]=128|63&n}else{if(i+3>=s)break;n>=2097152&&console.warn(`Invalid Unicode code point 0x${n.toString(16)} encountered when serializing a JS string to a UTF-8 string in wasm memory! (Valid unicode code points should be in range 0-0x1FFFFF).`),t[i++]=240|n>>18,t[i++]=128|n>>12&63,t[i++]=128|n>>6&63,t[i++]=128|63&n}}t[i]=0}(e,this._selfAlias.Module.HEAPU8,i,t),i}writeArrayBufferToWasm(e){const t=this.malloc(e.byteLength);return this._selfAlias.Module.HEAPU8.set(e,t),t}writeBufferToFFmpeg(e,t,i,r,s){return this._selfAlias.Module._writeFFmpegBuffer(e,t,i,r,s)}freePtr(e){this._selfAlias.Module._free(e)}malloc(e){return this._selfAlias.Module._malloc(e)}get heapU8(){return this._selfAlias.Module.HEAPU8}getStringFromWasm(e){return function(e,t,i){const r=t+void 0;let s="";for(;!(t>=r);){let i=e[t++];if(!i)return s;if(!(128&i)){s+=String.fromCharCode(i);continue}const r=63&e[t++];if(192==(224&i)){s+=String.fromCharCode((31&i)<<6|r);continue}const n=63&e[t++];if(224==(240&i)?i=(15&i)<<12|r<<6|n:(240!=(248&i)&&console.warn(`Invalid UTF-8 leading byte 0x${i.toString(16)} encountered when deserializing a UTF-8 string in wasm memory to a JS string!`),i=(7&i)<<18|r<<12|n<<6|63&e[t++]),i<65536)s+=String.fromCharCode(i);else{const e=i-65536;s+=String.fromCharCode(55296|e>>10,56320|1023&e)}}return s}(this._selfAlias.Module.HEAPU8,e)}initGlobalCallByCpp(){this._selfAlias.onVideoFrameCallback=this.onVideoFrameCallback.bind(this),this._selfAlias.onAudioFrameCallback=this.onAudioFrameCallback.bind(this),this._selfAlias.onErrorCallback=this.onErrorCallback.bind(this),this._selfAlias.onMetadataCallback=this.onMetadataCallback.bind(this),this._selfAlias.onPlayerStateChange=this.onPlayerStateChange.bind(this),this._selfAlias.httpjsOpenCallback=this.httpjsOpenCallback.bind(this),this._selfAlias.httpjsCloseCallback=this.httpjsCloseCallback.bind(this),this._selfAlias.onRequestNewBufferCallback=this.onRequestNewBufferCallback.bind(this),this._selfAlias.onBufferStateCallback=this.onBufferStateCallback.bind(this),this._selfAlias.onSeekStateCallback=this.onSeekStateCallback.bind(this),this._selfAlias.onEndedCallback=this.onEndedCallback.bind(this)}raiseInnerErr(e,t){s.b.log(`[WasmCppBridge] raiseInnerErr, code=${e}, message=${t}`),this.load();const i={cmd:r.b.CALL_MAIN_ERROR,code:e,message:t};this._selfAlias.postMessage(i)}onErrorCallback(e){this.raiseInnerErr(r.d.RUNTIME,`${r.e.PLAY_CORE_ERR}[${e}]`)}onMetadataCallback(e,t,i,s,n,a,o,l,u){const h={cmd:r.b.CALL_MAIN_UDPATE_METADATA,audioCodecName:r.c[i]||"unknown",videoCodecName:r.c[a]||"unknown",audioBitRate:e,videoBitRate:s,videoFrameRate:n,duration:+(u/1e3).toFixed(2),videoWidth:o,videoHeight:l,audioSampleRate:t};this._selfAlias.postMessage(h)}onVideoFrameCallback(e,t,i,s,n,a,o,l,u,h){const d=this._selfAlias.Module.HEAPU8,c=d.subarray(e,e+s*u),_=d.subarray(t,t+n*u/2),f=d.subarray(i,i+a*u/2),m=new Uint8Array(c).buffer,p=new Uint8Array(_).buffer,E=new Uint8Array(f).buffer,g={cmd:r.b.CALL_MAIN_REV_VIDEO_FRAME,dataYPtr:e,dataUPtr:t,dataVPtr:i,dataYSize:s,dataUSize:n,dataVSize:a,ptsMs:o,videoWidth:l,videoHeight:u,decodeCostTimeMs:h,dataY:m,dataU:p,dataV:E};this._selfAlias.postMessage(g,[m,p,E])}onAudioFrameCallback(e,t,i,s,n,a,o){const l=this._selfAlias.Module.HEAPU8.subarray(e,e+t),u=new Uint8Array(l).buffer,h={cmd:r.b.CALL_MAIN_REV_AUDIO_FRAME,dataPtr:e,pktSize:t,ptsMs:i,durationMs:s,format:n,sampleRate:a,channels:o,data:u};this._selfAlias.postMessage(h,[u])}onPlayerStateChange(e){this._videoStateInCpp=e,s.b.log("[WasmCppBridge] onPlayerStateChange, state="+e),this.innerStateChangeHandler(e);const t={cmd:r.b.CALL_MAIN_STATE_CHANGE,state:this._videoStateInCpp};this._selfAlias.postMessage(t)}httpjsOpenCallback(e){var t;null===(t=this._httpjsProtocol)||void 0===t||t.httpjsOpenCallback(e)}httpjsCloseCallback(e){var t;null===(t=this._httpjsProtocol)||void 0===t||t.httpjsCloseCallback(e)}onRequestNewBufferCallback(e,t=-1,i=0){var r;null===(r=this._httpjsProtocol)||void 0===r||r.onRequestNewBufferCallback(e,t,i)}onBufferStateCallback(e){const t={cmd:r.b.CALL_MAIN_BUFFER_STATE_CHANGE,isBuffering:e};this._selfAlias.postMessage(t)}onSeekStateCallback(e){const t={cmd:r.b.CALL_MAIN_SEEK_STATE_CHANGE,isSeeking:e};this._selfAlias.postMessage(t)}onEndedCallback(){const e={cmd:r.b.CALL_MAIN_ENDED};this._selfAlias.postMessage(e)}resetPlayer(){this.freeProtocol(),this.setMainLoopTimer(!1)}innerStateChangeHandler(e){e===r.k.PLAYER_API_STATE_IDLE&&this.resetPlayer()}setMainLoopTimer(e){this._mainLoopTimerID>0&&(this._selfAlias.clearInterval(this._mainLoopTimerID),this._mainLoopTimerID=0),e&&(this._mainLoopTimerID=this._selfAlias.setInterval(()=>{const e=this.getBufferedDurationMs();this._bufferedDuraionMs!==e&&(this._bufferedDuraionMs=e,this.onBufferChange(this._bufferedDuraionMs))},200))}createProtocol(e){this.freeProtocol(),this._httpjsProtocol=new A(this,e),this._httpjsProtocol.on(l,this.onProtocolError.bind(this))}freeProtocol(){this._httpjsProtocol&&(this._httpjsProtocol.destroy(),this._httpjsProtocol=null)}onProtocolError(e){var t,i;this.raiseInnerErr(null===(t=e.data)||void 0===t?void 0:t.code,null===(i=e.data)||void 0===i?void 0:i.message)}onBufferChange(e){const t={cmd:r.b.CALL_MAIN_BUFFER_CHANGE,bufferedDurationMs:e};this._selfAlias.postMessage(t)}}
  /*! *****************************************************************************
              Copyright (c) Microsoft Corporation.
              
              Permission to use, copy, modify, and/or distribute this software for any
              purpose with or without fee is hereby granted.
              
              THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
              REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
              AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
              INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
              LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
              OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
              PERFORMANCE OF THIS SOFTWARE.
              ***************************************************************************** */var b=function(){return(b=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var s in t=arguments[i])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)};function R(e,t,i,r){return new(i||(i=Promise))((function(s,n){function a(e){try{l(r.next(e))}catch(e){n(e)}}function o(e){try{l(r.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}l((r=r.apply(e,t||[])).next())}))}function y(e,t){var i,r,s,n,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return n={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function o(n){return function(o){return function(n){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,r&&(s=2&n[0]?r.return:n[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,n[1])).done)return s;switch(r=0,s&&(n=[2&n[0],s.value]),n[0]){case 0:case 1:s=n;break;case 4:return a.label++,{value:n[1],done:!1};case 5:a.label++,r=n[1],n=[0];continue;case 7:n=a.ops.pop(),a.trys.pop();continue;default:if(!((s=(s=a.trys).length>0&&s[s.length-1])||6!==n[0]&&2!==n[0])){a=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){a.label=n[1];break}if(6===n[0]&&a.label<s[1]){a.label=s[1],s=n;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(n);break}s[2]&&a.ops.pop(),a.trys.pop();continue}n=t.call(e,a)}catch(e){n=[6,e],r=0}finally{i=s=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,o])}}}function T(){for(var e=0,t=0,i=arguments.length;t<i;t++)e+=arguments[t].length;var r=Array(e),s=0;for(t=0;t<i;t++)for(var n=arguments[t],a=0,o=n.length;a<o;a++,s++)r[s]=n[a];return r}var S=function(){function e(){this.isLock=!1,this.data=[],this.buffer=[]}return e.prototype.push=function(e){var t=Date.now(),i=b(b({},e),{_date:t});this.isLock?this.buffer.push(i):this.data.push(i)},e.prototype.lock=function(){this.isLock=!0},e.prototype.unlock=function(e){void 0===e&&(e=!0),e&&(this.data=[]),this.isLock=!1,this.data=T(this.data,this.buffer),this.buffer=[]},e.prototype.count=function(){return this.data.length},e.prototype.getData=function(){return T(this.data)},e.prototype.waitExec=function(e,t){void 0===e&&(e=500),this.isLock||(clearTimeout(this.timer),this.timer=setTimeout((function(){t()}),e))},e}(),C=Math.pow(2,52),P=function(){function e(e){this.queueMap={},this.config=e}return e.prototype.canUseDB=function(){return!!indexedDB},e.prototype.open=function(e){var t=this;return new Promise((function(i,r){if(!t.canUseDB())return r({type:3});var s=t.config,n=s.name,a=s.version,o=s.stores,l=indexedDB.open(n,a);t.storeName=e,l.onsuccess=function(){t.db=l.result,t.removeExpiresData(),t.removeLimitData(),i()},l.onerror=function(e){r({type:1,event:e})},l.onupgradeneeded=function(){t.db=l.result;try{null==o||o.forEach((function(e){t.createStore(e)}))}catch(e){r({type:2,error:e})}}}))},e.prototype.close=function(){var e;null===(e=this.db)||void 0===e||e.close(),this.db=null},e.prototype.useStore=function(e){this.storeName=e},e.prototype.add=function(e){var t=this,i=this.config,r=i.gapTime,s=void 0===r?500:r,n=i.flushNum,a=void 0===n?50:n,o=this.getQueue();o.push(e),o.count()>=a?this.flush():o.waitExec(s,(function(){t.flush()}))},e.prototype.getAll=function(){return R(this,void 0,void 0,(function(){var e=this;return y(this,(function(t){switch(t.label){case 0:return[4,this.waitOpen()];case 1:return t.sent(),[2,new Promise((function(t,i){var r=e.getStore("readonly").openCursor(),s=[];r.onsuccess=function(){var e;if(null===(e=r.result)||void 0===e?void 0:e.value){var i=r.result.value;s.push(i),r.result.continue()}else t(s)},r.onerror=i}))]}}))}))},e.prototype.getLastRecord=function(){return this.getRecord("prev")},e.prototype.getFirstRecord=function(){return this.getRecord("next")},e.prototype.getCount=function(){return R(this,void 0,void 0,(function(){var e=this;return y(this,(function(t){switch(t.label){case 0:return[4,this.waitOpen()];case 1:return t.sent(),[2,new Promise((function(t,i){var r=e.getStore("readonly").count();r.onsuccess=function(){return t(r.result)},r.onerror=i}))]}}))}))},e.prototype.clear=function(e){var t=this;return void 0===e&&(e=.25),e>=1?new Promise((function(e,i){var r=t.getStore("readwrite").clear();r.onsuccess=e,r.onerror=i})):Promise.all([this.getFirstRecord(),this.getLastRecord()]).then((function(i){var r=i[0],s=i[1];if(r&&s){var n=Math.floor((s._id-r._id)*e+r._id);return t.removeDataBelowIndex("_id",n)}}))},e.prototype.put=function(e,t){return R(this,void 0,void 0,(function(){var i;return y(this,(function(r){switch(r.label){case 0:return[4,this.flush(1)];case 1:return r.sent(),i=this.getStore("readwrite"),[2,new Promise((function(r,s){var n=i.put(b(b({},e),{_date:Date.now()}),t);n.onsuccess=function(e){r(n.result)},n.onerror=s}))]}}))}))},e.prototype.get=function(e,t){return R(this,void 0,void 0,(function(){var i;return y(this,(function(r){switch(r.label){case 0:return[4,this.flush(1)];case 1:return r.sent(),i=this.getStore("readwrite"),[2,new Promise((function(r,s){var n=i.index(e).get(t);n.onsuccess=function(e){r(n.result)},n.onerror=s}))]}}))}))},e.prototype.removeDataBelowIndex=function(e,t){return R(this,void 0,void 0,(function(){var i=this;return y(this,(function(r){switch(r.label){case 0:return[4,this.waitOpen()];case 1:return r.sent(),[2,new Promise((function(r,s){var n=i.getStore("readwrite").index(e),a=IDBKeyRange.upperBound(t,!0),o=n.openCursor(a),l=0;o.onsuccess=function(e){var t=e.target.result;t?(l+=1,t.delete(),t.continue()):r(l)},o.onerror=s}))]}}))}))},e.prototype.waitOpen=function(){return R(this,void 0,void 0,(function(){return y(this,(function(e){switch(e.label){case 0:return this.db?[3,2]:[4,this.open(this.storeName)];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))},e.prototype.getStore=function(e){var t;return void 0===e&&(e="readonly"),null===(t=this.db)||void 0===t?void 0:t.transaction(this.storeName,e).objectStore(this.storeName)},e.prototype.removeExpiresData=function(){var e=this.config.expires;if(e&&e>0){var t=Date.now()-24*e*60*60*1e3;return this.removeDataBelowIndex("_date",t)}},e.prototype.removeLimitData=function(){return R(this,void 0,void 0,(function(){var e,t,i,r,s,n;return y(this,(function(a){switch(a.label){case 0:return e=this.config,t=e.limitNum,i=e.deleteGap,r=void 0===i?10:i,t?[4,this.getCount()]:[2];case 1:return a.sent()<=t?[2]:[4,this.getLastRecord()];case 2:return(s=a.sent())?(n=s._id-t+r,[2,this.removeDataBelowIndex("_id",n)]):[2]}}))}))},e.prototype.flush=function(e){return void 0===e&&(e=2),R(this,void 0,void 0,(function(){var t=this;return y(this,(function(i){switch(i.label){case 0:return[4,this.waitOpen()];case 1:return i.sent(),[2,new Promise((function(i,r){var s=t.getQueue();if(!t.db||!s.count()||s.isLock)return i();var n=t.db.transaction(t.storeName,"readwrite"),a=n.objectStore(t.storeName);s.getData().forEach((function(e){return a.add(e)})),s.lock(),n.oncomplete=function(){s.unlock(),t.removeLimitData(),i()},n.onerror=function(n){return R(t,void 0,void 0,(function(){var t,a,o;return y(this,(function(l){switch(l.label){case 0:return"QuotaExceededError"===(null===(o=null===(a=n.target)||void 0===a?void 0:a.error)||void 0===o?void 0:o.name)&&e?(t=this.config.deletePercent,this.clear(t),[2,this.flush(e-1).then(i)]):[4,this.resetId()];case 1:return l.sent()?[2,this.flush(e-1).then(i)]:(s.unlock(!1),r({type:5,event:n}),[2])}}))}))}}))]}}))}))},e.prototype.getRecord=function(e){return R(this,void 0,void 0,(function(){var t=this;return y(this,(function(i){switch(i.label){case 0:return[4,this.waitOpen()];case 1:return i.sent(),[2,new Promise((function(i,r){var s=t.getStore("readonly").openCursor(null,e);s.onsuccess=function(){var e,t=null===(e=s.result)||void 0===e?void 0:e.value;i(t)},s.onerror=r}))]}}))}))},e.prototype.getQueue=function(){return this.queueMap[this.storeName]||(this.queueMap[this.storeName]=new S),this.queueMap[this.storeName]},e.prototype.resetId=function(){return R(this,void 0,void 0,(function(){var e,t,i,r;return y(this,(function(s){switch(s.label){case 0:return[4,this.getLastRecord()];case 1:return e=s.sent(),C<e._id&&this.db?[4,this.getAll()]:[3,3];case 2:return t=s.sent(),i=this.db.transaction(this.storeName,"readwrite"),r=i.objectStore(this.storeName),t.forEach((function(e,t){return r.put({data:e,_id:t+1})})),[2,new Promise((function(e,t){i.oncomplete=function(){return e(!0)},i.onerror=function(e){return t(e)}}))];case 3:return[2,Promise.resolve(!1)]}}))}))},e.prototype.createStore=function(e){var t=e.name,i=e.indexes,r=void 0===i?[]:i;if(this.db){this.db.objectStoreNames.contains(t)&&this.db.deleteObjectStore(t);var s=this.db.createObjectStore(t,{keyPath:"_id",autoIncrement:!0}),n=["_id","_date"];r.filter((function(e){return!(-1!==n.indexOf(e.indexName))})).forEach((function(e){s.createIndex(e.indexName,e.keyPath,{unique:!!e.unique})})),n.forEach((function(e){return s.createIndex(e,e)}))}},e}(),w=function(e,t,i,r){return new(i||(i=Promise))((function(s,n){function a(e){try{l(r.next(e))}catch(e){n(e)}}function o(e){try{l(r.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}l((r=r.apply(e,t||[])).next())}))};class L{constructor(e,t){this._selfAlias=e,this._config=t,this.initOfflineWriter(this._config),this.initWasm(this._config)}initOfflineWriter(e){this._offlineCache=new P({name:"_thumbplayer_wasmbinary_1",version:1,stores:[{name:"wasmbinary",indexes:[{indexName:"_feat",keyPath:"_feat",unique:!0}]}]}),this._offlineCache.open("wasmbinary")}initWasm(e){return w(this,void 0,void 0,(function*(){const{featType:t}=e,i=`${r.a}/wasm${t}/${r.l[t]}`,n=`${i}/TPCore-wasm${t}.js`,a=`TPCore-wasm${t}.worker.js`,o=`${i}/TPCore-wasm${t}.wasm`,l=+new Date;this._selfAlias.Module={preRun:[],postRun:[],locateFile:e=>e===a&&this._spawnScriptObjUrl?this._spawnScriptObjUrl:`${i}/${e}`,mainScriptUrlOrBlob:n,print(...e){console.log.apply(null,[].concat(e))},printErr:console.error,onRuntimeInitialized:()=>{this.onRuntimeInitialized(+new Date-l)}};try{yield this.getWasmBinary(o,e)}catch(e){s.b.log("[WasmRuntimeCreater] getWasmBinary err: ",e)}this.loadAndSetInlineWasmScript(i,a,n)}))}loadAndSetInlineWasmScript(e,t,i){return w(this,void 0,void 0,(function*(){let n;try{n=yield o({url:`${e}/${t}?max_age=86400`,retryCount:2,responseType:"text"})}catch(e){const t=e;return s.b.log("[WasmRuntimeCreater] loadAndSetInlineWasmScript, wasmSpawnWorkerJs err: ",t),void this.raiseInnerErr(r.d.LOAD_WASM_SPWAN_WORKER_SCRIPT,r.e.LOAD_WASM_SCRIPT)}const a=new Blob([n.data],{type:"application/javascript"});let l;this._spawnScriptObjUrl=URL.createObjectURL(a);try{l=yield o({url:i+"?max_age=86400",retryCount:2,responseType:"text"})}catch(e){const t=e;return s.b.log("[WasmRuntimeCreater] loadAndSetInlineWasmScript, wasmMainScript err: ",t),void this.raiseInnerErr(r.d.LOAD_WASM_MAIN_SCRIPT,r.e.LOAD_WASM_SCRIPT)}const u=new Blob([l.data],{type:"application/javascript"}),h=URL.createObjectURL(u);this._selfAlias.importScripts(h),this._selfAlias.Module.mainScriptUrlOrBlob=u}))}onRuntimeInitialized(e){s.b.log("[WasmRuntimeCreater] onRuntimeInitialized, cost time=",e),this._selfAlias.Module._initPlayer(+this._config.wasmLogLevel);const t={cmd:r.b.CALL_MAIN_INIT_WORKER_OVER,initWasmCostTime:e};this._selfAlias.postMessage(t)}getWasmBinary(e,t){return w(this,void 0,void 0,(function*(){const{featType:i,closeIndexdb:n}=t;if("true"===n)return;const a=yield this._offlineCache.get("_feat",i);if(a&&r.l[i]===a.hash)return this._wasmBinary=a.data,void(this._selfAlias.Module.wasmBinary=this._wasmBinary);try{const t=yield o({url:e+"?max_age=86400",retryCount:2,responseType:"arraybuffer"});this._wasmBinary=t.data,this._selfAlias.Module.wasmBinary=this._wasmBinary}catch(e){return s.b.log("[WasmRuntimeCreater] loadAndSetInlineWasmScript, wasmSpawnWorkerJs err: ",e),void this.raiseInnerErr(r.d.LOAD_WASM,r.e.LOAD_WASM_SCRIPT)}this._wasmBinary&&this._offlineCache.put(Object.assign(Object.assign({},a),{_feat:i,data:this._wasmBinary,hash:r.l[i]})).then(()=>{s.b.log("[WasmRuntimeCreater] cache wasm succ")}).catch(e=>{var t;s.b.log("[WasmRuntimeCreater] cache wasm fail, ",null===(t=null==e?void 0:e.target)||void 0===t?void 0:t.error)})}))}raiseInnerErr(e,t){const i={cmd:r.b.CALL_MAIN_ERROR,code:e,message:t};this._selfAlias.postMessage(i)}}class O{constructor(e){this._selfAlias=e,this._selfAlias.onmessage=e=>{const{data:t}=e,{cmd:i}=t;switch(-1===[r.b.CALL_WORKER_PLAY_VIDEO_FRAME_OK,r.b.CALL_WORKER_PLAY_AUDIO_FRAME_OK].indexOf(i)&&s.b.log("[FakeVideoElementWorker] worker get main cmd, ",i),i){case r.b.CALL_WORKER_INIT_WORKER:this.initWorker(t);break;case r.b.CALL_WORKER_LOAD:this._wasmCppBridge.load(t.videoConfig);break;case r.b.CALL_WORKER_PLAY:this._wasmCppBridge.play(t.playbackRate);break;case r.b.CALL_WORKER_PAUSE:this._wasmCppBridge.pause();break;case r.b.CALL_WORKER_SEEK:this._wasmCppBridge.seek(t.timeS);break;case r.b.CALL_WORKER_SET_RATE:this._wasmCppBridge.setRate(t.rate);break;case r.b.CALL_WORKER_PLAY_AUDIO_FRAME_OK:this._wasmCppBridge.playAudioFrameOk();break;case r.b.CALL_WORKER_PLAY_VIDEO_FRAME_OK:this._wasmCppBridge.playVideoFrameOk()}}}initWorker(e){"true"===e.openLog&&Object(s.a)(!0),this._wasmCppBridge=new v(this._selfAlias,e),this._wasmRuntimeCreator=new L(this._selfAlias,e)}}},function(e,t,i){"use strict";i.r(t),i.d(t,"CDN_PATH",(function(){return r.a})),i.d(t,"SAB_STR",(function(){return r.j})),i.d(t,"WASM_HASH_MAP",(function(){return r.l})),i.d(t,"MAX_PLAYBACK_RATE",(function(){return r.h})),i.d(t,"MIN_PLAYBACK_RATE",(function(){return r.i})),i.d(t,"fakeVideoDefaultConfig",(function(){return r.m})),i.d(t,"CODEC_ID",(function(){return r.c})),i.d(t,"ERROR_CODE",(function(){return r.d})),i.d(t,"ERROR_MSG",(function(){return r.e})),i.d(t,"GENERAL_ERROR_MSG",(function(){return r.g})),i.d(t,"FAKE_VIDEO_ELEMENT_EVENT",(function(){return r.f})),i.d(t,"VIDEO_STATE_IN_CPP",(function(){return r.k})),i.d(t,"CMD",(function(){return r.b})),i.d(t,"FakeVideoElement",(function(){return A})),i.d(t,"enableLogs",(function(){return o.a})),i.d(t,"logger",(function(){return o.b})),i.d(t,"parseUrl",(function(){return b})),i.d(t,"FakeVideoEvent",(function(){return a})),i.d(t,"SimpleDefer",(function(){return l})),i.d(t,"FakeTimeRanges",(function(){return u})),i.d(t,"isEnvSupport",(function(){return R})),i.d(t,"IFRAME_EVENT",(function(){return y}));var r=i(0),s=i(3),n=i.n(s);class a extends Event{constructor(e,t){super(e),this.data=t}}var o=i(1);class l{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class u{constructor(e){this._timeArr=[],e&&(this._timeArr=[e])}get length(){return this._timeArr.length}setRange(e){this._timeArr=[e]}end(e){if(this._timeArr.length<=0)return 0;if(e>=this._timeArr.length)throw new Error(r.g.getTimeRangeErrorMsg("end",this._timeArr.length,e));return this._timeArr[e].end}start(e){if(this._timeArr.length<=0)return 0;if(e>=this._timeArr.length)throw new Error(r.g.getTimeRangeErrorMsg("start",this._timeArr.length,e));return this._timeArr[e].start}toString(){return`[${this.start(0)}, ${this.end(0)}]`}}var h=i(2);class d extends h.a{constructor(e){super(),this._playTime=0,this._volume=1,this._muted=!1,this._timeupdateFlag=!0,this._lastPts=Number.MIN_VALUE,this._sampleRate=44100,this._config=e,this._evtMap={audioCtx:this.onAudioCtxStateChange.bind(this)}}getMaxFormatValue(e){return[128,32768,2147483648,1][e]}initAudioContext(e){return e|=48e3,this._sampleRate=e,!(!this._muted&&!this._audioCtx&&(this._bufferSources=[],this._audioCtx=new AudioContext({sampleRate:e}),"suspended"===this._audioCtx.state?(o.b.log("[PCMPlayer] autoplay blocked"),this._audioCtx.close(),this._audioCtx=null,1):(this._audioCtx.addEventListener("statechange",this._evtMap.audioCtx),this._gainNode=this._audioCtx.createGain(),this._gainNode.gain.value=this._volume,this._gainNode.connect(this._audioCtx.destination),this._playTime=this._audioCtx.currentTime,0)))}onAudioCtxStateChange(e){o.b.log("[PCMPlayer] this._audioCtx.state>>>",this._audioCtx.state),this._audioCtx&&("suspended"===this._audioCtx.state?this._audioCtx.suspend():"running"===this._audioCtx.state&&this._audioCtx.resume())}stop(){var e,t;this.pause(),null===(e=this._bufferSources)||void 0===e||e.forEach(e=>{this.stopBufferSource(e,!1)}),null===(t=this._gainNode)||void 0===t||t.disconnect(),this._audioCtx&&(this._audioCtx.removeEventListener("statechange",this._evtMap.audioCtx),this._audioCtx.close(),this._audioCtx=null),this._playTime=0,this._timeupdateFlag=!0,this._bufferSources=null}getTypeArrayData(e){const t=new(0,[Uint8Array,Int16Array,Int32Array,Float32Array][e.format])(new Uint8Array(e.data).buffer),i=new Float32Array(t.length);for(let r=0;r<t.length;r++)i[r]=t[r]/this.getMaxFormatValue(e.format);return i}playFrame(e){if(this.initAudioContext(this._sampleRate),!this._audioCtx||this._muted)return void this.sendTimeupdateEvt(e.ptsMs);this._lastPts!==Number.MIN_VALUE&&Math.abs(this._lastPts-e.ptsMs)>300&&this.adjuestPlatTime(),this._lastPts=e.ptsMs,1e3*Math.abs(this._playTime-this._audioCtx.currentTime)>50&&"running"===this._audioCtx.state&&this.adjuestPlatTime();const{channels:t,sampleRate:i}=e,r=this.getTypeArrayData(e),s=this._audioCtx.createBufferSource();this._bufferSources.push(s),this._curBufferSource=s;const n=r.length/t,a=this._audioCtx.createBuffer(t,n,i);for(let e=0;e<t;e++){let i=e;const s=a.getChannelData(e);for(let e=0;e<n;e++)s[e]=r[i],i+=t}this._playTime<this._audioCtx.currentTime&&(this._playTime=this._audioCtx.currentTime),s.buffer=a,s.connect(this._gainNode),this.resume(),s.start(this._playTime),s.onended=e=>{this.stopBufferSource(e.currentTarget)},this._playTime+=a.duration,this.sendTimeupdateEvt(e.ptsMs)}adjuestPlatTime(){this.stopBufferSource(this._curBufferSource),this._playTime=this._audioCtx.currentTime}stopBufferSource(e,t=!0){if(e&&(e.stop(),e.disconnect(),e.buffer=null,e.onended=null,this._bufferSources&&t)){const t=this._bufferSources.indexOf(e);-1!==t&&this._bufferSources.splice(t,1)}}sendTimeupdateEvt(e){this._timeupdateFlag&&(this.emit(r.f.TIME_UPDATE,+(e/1e3).toFixed(2)),this._timeupdateFlag=!1,setTimeout(()=>{this._timeupdateFlag=!0},100))}setVolume(e){var t;if(e<0||e>1)throw new Error(`The volume provided (${e}) is outside the range [0, 1].`);this._volume=e,(null===(t=this._gainNode)||void 0===t?void 0:t.gain)&&(this._gainNode.gain.value=this._volume)}getVolume(){return this._volume}setMuted(e){this._muted=e}pause(){this._audioCtx&&"running"===this._audioCtx.state&&this._audioCtx.suspend()}resume(){this._audioCtx&&"suspended"===this._audioCtx.state&&this._audioCtx.resume()}destroy(){this.stop()}}const c=["attribute highp vec4 aVertexPosition;","attribute vec2 aTextureCoord;","varying highp vec2 vTextureCoord;","void main(void) {"," gl_Position = aVertexPosition;"," vTextureCoord = aTextureCoord;","}"].join("\n"),_=["precision highp float;","varying lowp vec2 vTextureCoord;","uniform sampler2D YTexture;","uniform sampler2D UTexture;","uniform sampler2D VTexture;","const mat4 YUV2RGB = mat4","("," 1.1643828125, 0, 1.59602734375, -.87078515625,"," 1.1643828125, -.39176171875, -.81296875, .52959375,"," 1.1643828125, 2.017234375, 0, -1.081390625,"," 0, 0, 0, 1",");","void main(void) {"," gl_FragColor = vec4( texture2D(YTexture, vTextureCoord).x, texture2D(UTexture, vTextureCoord).x, texture2D(VTexture, vTextureCoord).x, 1) * YUV2RGB;","}"].join("\n");class f{constructor(e){this._gl=e,this._texture=this._gl.createTexture(),this._gl.bindTexture(this._gl.TEXTURE_2D,this._texture),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE)}bind(e,t,i){this._gl.activeTexture([this._gl.TEXTURE0,this._gl.TEXTURE1,this._gl.TEXTURE2][e]),this._gl.bindTexture(this._gl.TEXTURE_2D,this._texture),this._gl.uniform1i(this._gl.getUniformLocation(t,i),e)}fill(e,t,i){this._gl.bindTexture(this._gl.TEXTURE_2D,this._texture),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.LUMINANCE,e,t,0,this._gl.LUMINANCE,this._gl.UNSIGNED_BYTE,i)}}class m{constructor(e,t){this._texcoords=[0,1,1,1,0,0,1,0],this._lastStridX=0,this._lastStridY=0,this._config=e,this._gl=Object.assign(t.getContext("webgl",{preserveDrawingBuffer:"none"!==this._config.captureType}),{y:null,u:null,v:null}),this.init()}init(){this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1);const e=this._gl.createProgram(),t=this._gl.createShader(this._gl.VERTEX_SHADER);this._gl.shaderSource(t,c),this._gl.compileShader(t);const i=this._gl.createShader(this._gl.FRAGMENT_SHADER);this._gl.shaderSource(i,_),this._gl.compileShader(i),this._gl.attachShader(e,t),this._gl.attachShader(e,i),this._gl.linkProgram(e),this._gl.useProgram(e),this._gl.getProgramParameter(e,this._gl.LINK_STATUS)||o.b.log("[YUV-player] [ER] Shader link failed.");const r=this._gl.getAttribLocation(e,"aVertexPosition");this._gl.enableVertexAttribArray(r);const s=this._gl.getAttribLocation(e,"aTextureCoord");this._gl.enableVertexAttribArray(s);const n=this._gl.createBuffer();this._gl.bindBuffer(this._gl.ARRAY_BUFFER,n),this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),this._gl.STATIC_DRAW),this._gl.vertexAttribPointer(r,2,this._gl.FLOAT,!1,0,0),this._texCoordBuffer=this._gl.createBuffer(),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._texCoordBuffer),this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(this._texcoords),this._gl.STATIC_DRAW),this._gl.vertexAttribPointer(s,2,this._gl.FLOAT,!1,0,0),this._gl.y=new f(this._gl),this._gl.u=new f(this._gl),this._gl.v=new f(this._gl),this._gl.y.bind(0,e,"YTexture"),this._gl.u.bind(1,e,"UTexture"),this._gl.v.bind(2,e,"VTexture")}playFrame(e){this._curVideoFrame=e;const{dataYSize:t,dataUSize:i,dataVSize:r,videoWidth:s,videoHeight:n,dataY:a,dataU:o,dataV:l}=e,u=new Uint8Array(a),h=new Uint8Array(o),d=new Uint8Array(l),{tarX:c,tarY:_,tarW:f,tarH:m}=this.getContainViewport(s||0,n||0,this._gl.canvas.width,this._gl.canvas.height);this.updateTexcoords(t,n,s,n),this._gl.viewport(c,_,f,m),this.clearView(),this._gl.y.fill(t,n,u),this._gl.u.fill(i,n/2,h),this._gl.v.fill(r,n/2,d),this._gl.drawArrays(this._gl.TRIANGLE_STRIP,0,4)}replayCurFrame(){this._curVideoFrame&&this.playFrame(this._curVideoFrame)}updateTexcoords(e,t,i,r){let s=0,n=0;e===i&&t===r||(s=(e-i+1)/e,n=(t-r)/t/2),s===this._lastStridX&&n===this._lastStridY||(this._lastStridX=s,this._lastStridY=n,this._lastStridX=s,this._lastStridY=n,this._texcoords[0]=0,this._texcoords[1]=1-n,this._texcoords[2]=1-s,this._texcoords[3]=1-n,this._texcoords[4]=0,this._texcoords[5]=0+n,this._texcoords[6]=1-s,this._texcoords[7]=0+n,this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._texCoordBuffer),this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(this._texcoords),this._gl.STATIC_DRAW))}getContainViewport(e,t,i,r){const s=e/t,n=i/r;let a=0,o=0,l=i,u=r;return s>n?(l=i,u=Math.round(i/e*t),a=0,o=Math.round((r-u)/2)):s<n&&(u=r,l=Math.round(r/t*e),o=0,a=Math.round((i-l)/2)),{tarX:a,tarY:o,tarW:l,tarH:u}}clearView(){this._gl&&(this._gl.clearColor(0,0,0,0),this._gl.clear(this._gl.COLOR_BUFFER_BIT))}stop(){}destroy(){this.clearView(),this._config=null,this._gl=null,this._curVideoFrame=null}}class p{constructor(){this.hasPaused=!1,this.lastSampleTime=0,this.frameRate=25,this.playbackRate=1,this.creationTime=Date.now(),this.droppedVideoFrames=0,this.totalVideoFrames=0,this.hbTimestamp=0,this.hbCallback=()=>{const e=performance.now();(this.hasPaused||e-this.hbTimestamp<=g)&&(this.hbTimestamp=e)},this.setHeartBeatStatus(!0),this.reset()}get playbackQuality(){const{creationTime:e,droppedVideoFrames:t,totalVideoFrames:i}=this;return{creationTime:e,droppedVideoFrames:t,totalVideoFrames:i}}reset(){this.lastSampleTime=0,this.creationTime=Date.now(),this.droppedVideoFrames=0,this.totalVideoFrames=0,this.hasPaused=!0}pause(){this.sample(),this.hasPaused=!0}resume(){this.hasPaused&&(this.hasPaused=!1,this.lastSampleTime=performance.now())}setPlaybackRate(e){this.sample(),this.playbackRate=e}setFrameRate(e){this.sample(),this.frameRate=e}sample(){const e=performance.now();if(this.hasPaused)return;if(e-this.hbTimestamp>g)return o.b.warn("[playback-quality] sample skipped due to heartBeat timeout"),this.hbTimestamp=e,this.lastSampleTime=e,void(this.totalVideoFrames+=1);const{lastSampleTime:t}=this;if(t>0){const i=e-t,r=1/this.frameRate*1e3;this.totalVideoFrames+=Math.round(i/1e3*this.frameRate*this.playbackRate),i>=2*r&&(o.b.warn("[playback-quality] stalled detected, render gap: "+i),this.droppedVideoFrames+=Math.floor((i-r)/r*this.playbackRate))}this.lastSampleTime=e}destroy(){this.setHeartBeatStatus(!1)}setHeartBeatStatus(e=!0){clearInterval(this.hbTimer),e&&(this.hbTimestamp=performance.now(),this.hbTimer=self.setInterval(this.hbCallback,E))}}const E=300,g=1e3;class A extends HTMLElement{constructor(){super(),this._quality=new p,this._playbackRate=1,this._state=r.k.PLAYER_API_STATE_IDLE,this._metadata={},this._volume=1,this._muted=!1,this._wasmReadyDefer=new l,this._buffered=new u,this._currentTime=0,this._paused=!1,this._ended=!1,this._seeking=!1,this._buffering=!1,this._readyState=0,this._isInited=!1,this._preFrameRenderTimeStamp=0,this._wasmWorker=n()(4),this._wasmMsgHandlerMap={[r.b.CALL_MAIN_INIT_WORKER_OVER]:this.initWorkerOverHandler.bind(this),[r.b.CALL_MAIN_REV_AUDIO_FRAME]:this.receiveAudioFrameHandler.bind(this),[r.b.CALL_MAIN_REV_VIDEO_FRAME]:this.receiveVideoFrameHandler.bind(this),[r.b.CALL_MAIN_UDPATE_METADATA]:this.updateMetadataHandler.bind(this),[r.b.CALL_MAIN_STATE_CHANGE]:this.stateChangeHandler.bind(this),[r.b.CALL_MAIN_BUFFER_CHANGE]:this.bufferChangehandler.bind(this),[r.b.CALL_MAIN_BUFFER_STATE_CHANGE]:this.bufferStateChangehandler.bind(this),[r.b.CALL_MAIN_SEEK_STATE_CHANGE]:this.seekStateChangehandler.bind(this),[r.b.CALL_MAIN_ERROR]:this.errorHandler.bind(this),[r.b.CALL_MAIN_ENDED]:this.endedHandler.bind(this)},this.createShadowRoot(),this.addResizeObserver(),this.setEvts(!0)}canPlayType(e){return"maybe"}set srcConfig(e){this._src=e}get srcConfig(){return this._src}get duration(){return this._metadata.duration||0}get videoWidth(){return this._metadata.videoWidth||0}get videoHeight(){return this._metadata.videoHeight||0}get buffered(){return this._buffered}get muted(){return this._muted}set muted(e){var t;this._muted!==e&&(this._muted=e,null===(t=this._pcmPlayer)||void 0===t||t.setMuted(e),this.emit(r.f.VOLUME_CHANGE,this._volume))}get paused(){return this._paused}get ended(){return this._ended}set currentTime(e){this._currentTime!==e&&this._wasmReadyDefer.promise.then(()=>this.seekInner(e))}get currentTime(){return this._currentTime}get seeking(){return this._seeking}get played(){return new u({start:0,end:this._currentTime})}get seekable(){return new u({start:0,end:this.duration})}get error(){return this._error}get readyState(){return this._readyState}get playbackRate(){return this._playbackRate}set playbackRate(e){if(this._playbackRate===e)return;if(-1===[r.k.PLAYER_API_STATE_PAUSED,r.k.PLAYER_API_STATE_STARTED].indexOf(this._state))return void o.b.log(`[FakeVideoElement] set playbackRate in invaild state ${this._state}.`);if(e<r.i||e>r.h)return;this._playbackRate=e,this._quality.setPlaybackRate(e);const t={cmd:r.b.CALL_WORKER_SET_RATE,rate:e};this._wasmWorker.postMessage(t),Promise.resolve().then(()=>{this.emit(r.f.RATE_CHANGE,this._playbackRate)})}set volume(e){var t;if(this._volume!==e){if(e<0||e>1)throw new Error(`The volume provided (${e}) is outside the range [0, 1].`);this._volume=e,null===(t=this._pcmPlayer)||void 0===t||t.setVolume(e),this.emit(r.f.VOLUME_CHANGE,this._volume)}}get volume(){return this._volume}getVideoPlaybackQuality(){return this._quality.playbackQuality}load(){Promise.all([this._wasmReadyDefer.promise,this.waitingStopState()]).then(()=>this.loadInner()).catch(console.log)}play(){return Promise.all([this._wasmReadyDefer.promise,this.waitingStopState()]).then(()=>this.playInner())}captureVideo(e=0,t=0,i=0,s=0){const n=e=>(this.emit(r.f.CAPTURE_OVER,e),e.error?Promise.reject(e.error):Promise.resolve(e));if(-1===["dataUrl","imageData"].indexOf(this._config.captureType))return n({error:new Error("captureType must be set to dataUrl/imageData")});const a=0===i?this._canvasDom.width:i,o=0===s?this._canvasDom.height:s,l=this._canvasDom.width,u=this._canvasDom.height;if(a<=0||o<=0||a>l||o>u||e<0||t<0||e>=l||t>=u)return n({error:new Error("args illegal")});let h,d;try{if("dataUrl"===this._config.captureType)h=this._canvasDom.toDataURL();else{const i=document.createElement("canvas");i.width=a,i.height=o;const r=i.getContext("2d");r.drawImage(this._canvasDom,e,t,a,o,0,0,a,o),h=r.getImageData(0,0,a,o)}}catch(e){d=e}return n({data:h,captureX:e,captureY:t,captureWidth:a,captureHeight:o,playtime:this._currentTime,error:d})}pause(){var e;if(-1===[r.k.PLAYER_API_STATE_STARTED].indexOf(this._state))return void o.b.log(`[FakeVideoElement] call pause in invaild state ${this._state}.`);this._quality.pause(),null===(e=this._pcmPlayer)||void 0===e||e.pause();const t={cmd:r.b.CALL_WORKER_PAUSE};this._wasmWorker.postMessage(t)}connectedCallback(){this.init()}destroy(){this.setEvts(!1),this._quality.destroy(),this._wasmWorker&&(this._wasmWorker.terminate(),this._wasmWorker=null),this._canvasDom&&(this._canvasDom.remove(),this._canvasDom=null),this._pcmPlayer&&(this._pcmPlayer.destroy(),this._pcmPlayer=null),this._yuvPlayer&&(this._yuvPlayer.destroy(),this._yuvPlayer=null),this._evtMap=null}createShadowRoot(){const e=this.attachShadow({mode:"open"}),t=document.createElement("div");t.innerHTML="<canvas></canvas>",this._canvasDom=t.firstChild,e.appendChild(this._canvasDom)}addResizeObserver(){window.ResizeObserver&&(this._resizeObserver=new ResizeObserver(e=>{this.updateStyle()}),this._resizeObserver.observe(this))}updateStyle(){this._canvasDom.setAttribute("width",String(this.clientWidth*devicePixelRatio)),this._canvasDom.setAttribute("height",String(this.clientHeight*devicePixelRatio)),this._canvasDom.setAttribute("style","width: 100%; height: 100%"),this._paused&&this._yuvPlayer.replayCurFrame()}init(){if(this._isInited)return;this._isInited=!0;const e={};Object.keys(r.m).forEach(t=>{const i=this.getAttribute(t);i&&(e[t]=i)}),this._config=Object.assign(Object.assign({},r.m),e),"true"===this._config.openLog&&Object(o.a)(!0),o.b.log("[FakeVideoElement] init(), ",this._config),this.updateStyle(),this._wasmWorker.postMessage(Object.assign({cmd:r.b.CALL_WORKER_INIT_WORKER},this._config))}emit(e,t){this.dispatchEvent(new a(e,t))}setEvts(e){this._evtMap||(this._evtMap={onWasmWorkerMsg:this.onWasmWorkerMsg.bind(this)}),o.b.log("[FakeVideoElement] setEvts, ",e),this._wasmWorker&&(this._wasmWorker.onmessage=e?this._evtMap.onWasmWorkerMsg:null)}canRenderState(e){return-1!==[r.k.PLAYER_API_STATE_STARTED,r.k.PLAYER_API_STATE_PAUSED].indexOf(e)}initWorkerOverHandler(e){o.b.log("[FakeVideoElement] ready!"),this._yuvPlayer=new m(this._config,this._canvasDom),this._pcmPlayer=new d(this._config),this._pcmPlayer.setVolume(this._volume),this._pcmPlayer.setMuted(this._muted),this._pcmPlayer.on(r.f.TIME_UPDATE,this.onTimeupdate.bind(this)),this._wasmReadyDefer.resolve()}loadInner(){if(!this._src)return o.b.log("[FakeVideoElement] call loadInner with null src, then resetInner()"),void this.resetInner();if(-1===[r.k.PLAYER_API_STATE_IDLE].indexOf(this._state))return void o.b.log(`[FakeVideoElement] call loadInner in invaild state ${this._state}.`);this.emit(r.f.WAITING),this._loadDefer=new l;const e={cmd:r.b.CALL_WORKER_LOAD,videoConfig:this._src};this._wasmWorker.postMessage(e)}playInner(){return this._src?-1!==[r.k.PLAYER_API_STATE_PAUSED].indexOf(this._state)?(this._wasmWorker.postMessage({cmd:r.b.CALL_WORKER_PLAY}),this._quality.resume(),this._pcmPlayer.resume(),Promise.resolve()):(this._loadDefer||this.loadInner(),this._loadDefer.promise.then(()=>-1===[r.k.PLAYER_API_STATE_PREPARED].indexOf(this._state)?(o.b.log(`[FakeVideoElement] call playInner in invaild state ${this._state}.`),Promise.resolve()):this._pcmPlayer.initAudioContext(this._metadata.audioSampleRate)?(this._wasmWorker.postMessage({cmd:r.b.CALL_WORKER_PLAY,playbackRate:this._playbackRate}),this._quality.resume(),Promise.resolve()):(this._quality.pause(),Promise.reject(new DOMException(r.g.BLOCK_ERROR_MSG))))):(o.b.log("[FakeVideoElement] "+r.g.NULL_SOURCE_ERROR_MSG),Promise.reject(new DOMException(r.g.NULL_SOURCE_ERROR_MSG)))}seekInner(e){if(-1===[r.k.PLAYER_API_STATE_PAUSED,r.k.PLAYER_API_STATE_STARTED].indexOf(this._state))return void o.b.log(`[FakeVideoElement] call seekInner in invaild state ${this._state}.`);if(e<0||e>=this._metadata.duration)return;const t={cmd:r.b.CALL_WORKER_SEEK,timeS:e};this._wasmWorker.postMessage(t)}resetInner(){-1===[r.k.PLAYER_API_STATE_IDLE].indexOf(this._state)?(this._wasmWorker.postMessage({cmd:r.b.CALL_WORKER_LOAD,videoConfig:null}),this._quality.reset(),this._pcmPlayer.stop(),this._yuvPlayer.stop(),this._loadDefer=null,this._readyState=0,this._buffered=new u,this._currentTime=0,this._metadata={},this._error=void 0,this._seeking=!1,this.startListenStopState()):o.b.log(`[FakeVideoElement] call resetInner in invaild state ${this._state}.`)}startListenStopState(){this._stopDefer=new l}resolveStopState(){var e;null===(e=this._stopDefer)||void 0===e||e.resolve(),this._stopDefer=null}waitingStopState(){return this._stopDefer?this._stopDefer.promise:Promise.resolve()}receiveAudioFrameHandler(e){this.canRenderState(this._state)&&(this._pcmPlayer.playFrame(e),this._wasmWorker.postMessage({cmd:r.b.CALL_WORKER_PLAY_AUDIO_FRAME_OK}))}receiveVideoFrameHandler(e){this.canRenderState(this._state)&&(this._yuvPlayer.playFrame(e),this.afterVideoFrameRender(e),this._wasmWorker.postMessage({cmd:r.b.CALL_WORKER_PLAY_VIDEO_FRAME_OK}))}updateMetadataHandler(e){this._metadata=Object.assign(this._metadata,e),this._metadata.duration>0&&this.emit(r.f.DURATION_CHANGE,this.duration),this._metadata.videoWidth>0&&this.emit(r.f.LOADED_METADATA,this._metadata),this._metadata.videoFrameRate>0&&this._quality.setFrameRate(this._metadata.videoFrameRate)}stateChangeHandler(e){const t=this._state,i=e.state;t!==i&&(o.b.log(`[FakeVideoElement] state change from [${t}] to [${i}].`),this._state=i,this.innerStateChangeHandler(i),this.emit(r.f.STATE_CHANGE,{old:t,new:i}))}innerStateChangeHandler(e){if(e!==r.k.PLAYER_API_STATE_IDLE)return e===r.k.PLAYER_API_STATE_PREPARED?(this._loadDefer.resolve(),this._readyState=4,void this.emit(r.f.CANPLAY)):e===r.k.PLAYER_API_STATE_PAUSED?(this._paused=!0,void this.emit(r.f.PAUSE)):e===r.k.PLAYER_API_STATE_STARTED?(this._paused=!1,void this.gotoPlaying()):void 0;this.resolveStopState()}endedHandler(){this._ended=!0,this.emit(r.f.ENDED)}bufferChangehandler(e){const t=null==e?void 0:e.bufferedDurationMs;if(t<=0)return;const i=Math.max(0,this._currentTime-1),s=Math.min(this._currentTime+t/1e3,this.duration);this._buffered.setRange({start:i,end:s}),this.emit(r.f.PROGRESS,{start:i,end:s})}bufferStateChangehandler(e){this._buffering=1===e.isBuffering,this._buffering?(this._quality.pause(),this.emit(r.f.WAITING)):this._state!==r.k.PLAYER_API_STATE_STARTED||this._seeking||(this.gotoPlaying(),this._quality.resume())}seekStateChangehandler(e){this._seeking=1===e.isSeeking,this._seeking?(this._quality.pause(),this.emit(r.f.SEEKING)):(this.emit(r.f.SEEKED),this._state===r.k.PLAYER_API_STATE_STARTED&&(this.gotoPlaying(),this._quality.resume()))}errorHandler(e){this._error=e,this.emit(r.f.ERROR,this._error)}onWasmWorkerMsg(e){const{data:t}=e,{cmd:i}=t;-1===[r.b.CALL_MAIN_REV_AUDIO_FRAME,r.b.CALL_MAIN_REV_VIDEO_FRAME,r.b.CALL_MAIN_BUFFER_CHANGE].indexOf(i)&&o.b.log("[FakeVideoElement] main-thread get cmd: ",i),this._wasmMsgHandlerMap[i]&&(delete t.cmd,this._wasmMsgHandlerMap[i](t))}onTimeupdate(e){this._seeking||(this._currentTime=e.data,this._currentTime>0&&(this._ended=!1),this.emit(r.f.TIME_UPDATE,this._currentTime))}gotoPlaying(){this._preFrameRenderTimeStamp=0,this.emit(r.f.PLAYING)}afterVideoFrameRender(e){const{decodeCostTimeMs:t,ptsMs:i}=e,s=performance.now();let n=this._metadata.videoFrameRate>0?1e3/this._metadata.videoFrameRate/this.playbackRate:0;this._quality.sample(),this._preFrameRenderTimeStamp>0&&this._state===r.k.PLAYER_API_STATE_STARTED&&!this._seeking&&!this._buffering&&!this._paused&&(n=s-this._preFrameRenderTimeStamp),this._preFrameRenderTimeStamp=s;const{totalVideoFrames:a,droppedVideoFrames:o}=this._quality.playbackQuality;this.emit(r.f.VIDEO_FRAME_RENDER,{ptsMs:i,decodeCostTimeMs:t,renderCostTime:n,totalVideoFrames:a,droppedVideoFrames:o})}}function v(e){try{return decodeURIComponent(e.replace(/\+/g," "))}catch(e){return null}}function b(e){const[t,i=""]=e.split("#"),[r,s=""]=t.split("?"),n=v(i),a=Object.create(null);return s.split("&").forEach(e=>{const[t,i=""]=e.split("="),r=v(t),s=v(i);null===r||null===s||""===r&&""===s||a[r]||(a[r]=s)}),{url:r,query:a,hash:n}}function R(){return window.SharedArrayBuffer&&window.WebAssembly&&window.Atomics}var y;window.customElements&&window.customElements.define("fake-video",A),function(e){e.IFRAME_READY="iframeReady"}(y||(y={}))}])},function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(0);let s=0,n=0;class a extends HTMLElement{constructor(){super(),this._playbackRate=1,this._currentTime=0,this._volume=1,this._muted=!1,this._instIdx=""+s++,this._metadata={},this._iframeReadyDefer=new r.SimpleDefer,this._iframeReadyTimeout=0,this._iframeEvtHandler=this.onReceiveWindowMsg.bind(this),this._duration=0,this._buffered=new r.FakeTimeRanges,this._paused=!1,this._ended=!1,this._seeking=!1,this._readyState=0,this._isInited=!1,this._videoPlaybackQuality={totalVideoFrames:0,droppedVideoFrames:0},this._fakeVideoElemenetEvtMap={[r.FAKE_VIDEO_ELEMENT_EVENT.LOADED_METADATA]:this.loadedMetadataHandler.bind(this),[r.FAKE_VIDEO_ELEMENT_EVENT.TIME_UPDATE]:this.timeupdateHandler.bind(this),[r.FAKE_VIDEO_ELEMENT_EVENT.VOLUME_CHANGE]:this.volumechangeHandler.bind(this),[r.FAKE_VIDEO_ELEMENT_EVENT.RATE_CHANGE]:this.ratechangeHandler.bind(this),[r.FAKE_VIDEO_ELEMENT_EVENT.DURATION_CHANGE]:this.durationchangeHandler.bind(this),[r.FAKE_VIDEO_ELEMENT_EVENT.PAUSE]:this.pauseHandler.bind(this),[r.FAKE_VIDEO_ELEMENT_EVENT.PLAYING]:this.playingHandler.bind(this),[r.FAKE_VIDEO_ELEMENT_EVENT.ENDED]:this.endedHandler.bind(this),[r.FAKE_VIDEO_ELEMENT_EVENT.PROGRESS]:this.progressHandler.bind(this),[r.FAKE_VIDEO_ELEMENT_EVENT.SEEKING]:this.seekingHandler.bind(this),[r.FAKE_VIDEO_ELEMENT_EVENT.SEEKED]:this.seekedHandler.bind(this),[r.FAKE_VIDEO_ELEMENT_EVENT.ERROR]:this.errorHandler.bind(this),[r.FAKE_VIDEO_ELEMENT_EVENT.CAPTURE_OVER]:this.captureOverHandler.bind(this),[r.FAKE_VIDEO_ELEMENT_EVENT.VIDEO_FRAME_RENDER]:this.videoFrameRenderHandler.bind(this),[r.IFRAME_EVENT.IFRAME_READY]:this.iframeReadyHandler.bind(this)},this.createShadowRoot(),this.setEvts(!0)}canPlayType(e){return"maybe"}set srcConfig(e){this._currentSrc=e,this.postMessageToIframe({functionName:"set srcConfig",functionParams:[e]})}get srcConfig(){return this._currentSrc}get duration(){return this._duration}get videoWidth(){return this._metadata.videoWidth||0}get videoHeight(){return this._metadata.videoHeight||0}get buffered(){return this._buffered}get muted(){return this._muted}set muted(e){this._muted!==e&&(this._muted=e,this.postMessageToIframe({functionName:"set muted",functionParams:[e]}))}get paused(){return this._paused}get ended(){return this._ended}get readyState(){return this._readyState}set currentTime(e){this._currentTime!==e&&(this._currentTime=e,this.postMessageToIframe({functionName:"set currentTime",functionParams:[e]}))}get currentTime(){return this._currentTime}get seeking(){return this._seeking}get played(){return new r.FakeTimeRanges({start:0,end:this._currentTime})}get seekable(){return new r.FakeTimeRanges({start:0,end:this.duration})}get error(){return this._error}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate!==e&&(this._playbackRate=e,this.postMessageToIframe({functionName:"set playbackRate",functionParams:[e]}))}set volume(e){this._volume!==e&&(this._volume=e,this.postMessageToIframe({functionName:"set volume",functionParams:[e]}))}get volume(){return this._volume}getVideoPlaybackQuality(){return this._videoPlaybackQuality}load(){this.postMessageToIframe({functionName:"load"})}play(){if(!this._currentSrc)return Promise.reject(new DOMException(r.GENERAL_ERROR_MSG.NULL_SOURCE_ERROR_MSG));const e=++n,t=this.waitingPlayReturn(e);return this.postMessageToIframe({uid:e,functionName:"play"}),t}captureVideo(e=0,t=0,i=0,s=0){if(this._captureDefer)return Promise.reject("video is being captured");const n=new r.SimpleDefer;return this._captureDefer=n,this.postMessageToIframe({functionName:"captureVideo",functionParams:[e,t,i,s]}),n.promise}pause(){this.postMessageToIframe({functionName:"pause"})}destroy(){this.setEvts(!1),this._fakeVideoElemenetEvtMap=null,this._iframeReadyTimeout>0&&(window.clearTimeout(this._iframeReadyTimeout),this._iframeReadyTimeout=0),this._iframe&&(this.postMessageToIframe({functionName:"destroy"}),this._iframe.remove(),this._iframe=null),this._iframeReadyDefer=null}connectedCallback(){this.init()}createShadowRoot(){this._iframe=document.createElement("iframe");const e={frameborder:"0",allowFullScreen:"true",allow:"autoplay"};Object.keys(e).forEach(t=>{this._iframe.setAttribute(t,e[t])}),this._iframe.style.position="absolute",this._iframe.style.width="100%",this._iframe.style.height="100%",this._iframe.style.top="0",this._iframe.style.left="0",this.attachShadow({mode:"open"}).appendChild(this._iframe)}init(){if(this._isInited)return;this._isInited=!0;const e={};Object.keys(r.fakeVideoDefaultConfig).forEach(t=>{const i=this.getAttribute(t);i&&(e[t]=i)}),this._config=Object.assign(Object.assign({},r.fakeVideoDefaultConfig),e),r.logger.log("[FakeVideoElementIframeWrapper] init()",this._config),"true"===this._config.openLog&&Object(r.enableLogs)(!0);const t=[];Object.keys(this._config).forEach(e=>{t.push(`${e}=${this._config[e]}`)}),t.push(`origin=${location.protocol}//${location.host}`),t.push("instIdx="+this._instIdx),this._iframe.src=`${r.CDN_PATH}/1.0.28/fake-video-element-iframe.html?${t.join("&")}`,this._iframeReadyTimeout=window.setTimeout(()=>{this._error={code:r.ERROR_CODE.LOAD_IFRAME,message:r.ERROR_MSG.LOAD_WASM_SCRIPT},this.emit(r.FAKE_VIDEO_ELEMENT_EVENT.ERROR)},8e3)}emit(e,t){this.dispatchEvent(new r.FakeVideoEvent(e,t))}setEvts(e){this._iframe&&(e?window.addEventListener("message",this._iframeEvtHandler):window.removeEventListener("message",this._iframeEvtHandler))}onReceiveWindowMsg(e){const{source:t,data:i}=e,{evtType:s,evtData:n,instIdx:a}=i;t!==window&&a===this._instIdx&&s&&(-1===[r.FAKE_VIDEO_ELEMENT_EVENT.TIME_UPDATE,r.FAKE_VIDEO_ELEMENT_EVENT.PROGRESS,r.FAKE_VIDEO_ELEMENT_EVENT.VIDEO_FRAME_RENDER].indexOf(s)&&r.logger.log(`[FakeVideoElementIframeWrapper] (${a})onReceiveWindowMsg, evtType=${s}`,n),this._fakeVideoElemenetEvtMap[s]&&this._fakeVideoElemenetEvtMap[s](n),this.emit(s,n))}loadedMetadataHandler(e){this._metadata=Object.assign(this._metadata,e),this._readyState=4}timeupdateHandler(e){this._currentTime=e,this._currentTime>0&&(this._ended=!1)}volumechangeHandler(e){this._volume=e}ratechangeHandler(e){this._playbackRate=e}durationchangeHandler(e){this._duration=e}pauseHandler(){this._paused=!0}playingHandler(){this._paused=!1}endedHandler(){this._ended=!0}progressHandler(e){this._buffered.setRange(e)}seekingHandler(){this._seeking=!0}seekedHandler(){this._seeking=!1}errorHandler(e){this._error=e}captureOverHandler(e){this._captureDefer&&(e.error?this._captureDefer.reject(e.error):this._captureDefer.resolve(e),this._captureDefer=null)}videoFrameRenderHandler(e){this._videoPlaybackQuality.totalVideoFrames=e.totalVideoFrames,this._videoPlaybackQuality.droppedVideoFrames=e.droppedVideoFrames}iframeReadyHandler(){this._iframeReadyTimeout>0&&(window.clearTimeout(this._iframeReadyTimeout),this._iframeReadyTimeout=0),this._iframeReadyDefer.resolve()}postMessageToIframe(e){const t=this._iframe;this._iframeReadyDefer.promise.then(()=>{var i;null===(i=t.contentWindow)||void 0===i||i.postMessage(e,"*")}).catch(console.log)}waitingPlayReturn(e){const t=new r.SimpleDefer,i=r=>{const{source:s,data:n}=r,{uid:a,evtData:o,instIdx:l}=n;if(s===window||l!==this._instIdx||!a||a!==e)return;window.removeEventListener("message",i);const{functionName:u,functionReturnType:h,functionReturnData:d}=o;if("play"===u&&"Promise"===h){const{state:e,data:i}=d;"fulfilled"===e?t.resolve(i):t.reject(i)}};return window.addEventListener("message",i),t.promise}}window.customElements&&window.customElements.define("fake-iframe-video",a)},function(e,t,i){"use strict";i.r(t);var r=i(1);i.d(t,"FakeIframeVideoElement",(function(){return r.a}));var s=i(0);for(var n in s)["FakeIframeVideoElement","default"].indexOf(n)<0&&function(e){i.d(t,e,(function(){return s[e]}))}(n)}])},function(e,t,i){"use strict";i.d(t,"a",(function(){return u}));var r=i(0),s=i(1),n=i(3),a=i(4),o=i(6),l=function(){return(l=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var s in t=arguments[i])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)},u=function(){function e(e){return e.maxVideoNodeCount=1,e.wasmKernelConfig=l(l({},s.fakeVideoDefaultConfig),e.wasmKernelConfig),(null==e?void 0:e.type)===r.PLAY_MODE.LIVE?new a.a(e):new o.a(e)}return e.isEnvSupport=Object(n.a)(),e.canPlayType=r.CAN_PLAY_ALL,e}()},function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i(0);function s(){return!!window.WebAssembly&&!!window.customElements&&r.commonTool.supportES6()&&r.videoTool.supportWebGL()}},function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r,s=i(0),n=i(5),a=(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),o=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.kernelName=s.KERNEL_NAME.WASM,t}return a(t,e),t.prototype.createVideoNode=function(e){return new n.a(e)},t}(s.BaseLivePlayer)},function(e,t,i){"use strict";i.d(t,"a",(function(){return u}));var r,s=i(0),n=i(1),a=i(2),o=(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),l=function(){return(l=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var s in t=arguments[i])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)};n.FakeIframeVideoElement;var u=function(e){function t(t){var i=e.call(this,t)||this;return i.insertInteractDom(),i._videoEventMap[n.FAKE_VIDEO_ELEMENT_EVENT.VIDEO_FRAME_RENDER]=i.onVideoFrameRender.bind(i),i}return o(t,e),t.prototype.insertInteractDom=function(){this.interactDom=s.domTool.creatDom('\n      <div style="position:absolute;left:0;top:0;width:100%;height:100%;z-index:100;">\n      </div>\n    '.trim()),s.domTool.append(this._videoElementContainer,this.interactDom)},t.prototype.onVideoFrameRender=function(e){var t=e.data||{},i=t.renderCostTime,r=t.decodeCostTimeMs;this.emit(s.VIDEO_NODE_EVENT.VIDEO_FRAME_RENDER,{renderCostTime:i,decodeCostTimeMs:r,videoInfo:this._videoInfo})},t.prototype.onVideoEventLoadedmetadata=function(t){if(null==t?void 0:t.data){var i=t.data,r=i.videoCodecName,s=i.audioCodecName,n=i.videoFrameRate;this._videoInfo.codecs={video:r,audio:s},this._videoInfo.videoFrameRate=n}e.prototype.onVideoEventLoadedmetadata.call(this)},t.prototype.findFreeVideoElement=function(){var e=this;if(!this.fakeVideoElement){this.fakeVideoElement=document.createElement("fake-iframe-video");var t=l({openLog:this._config.logLevel>=s.PLAYER_LOG_LEVEL.KERNEL?"true":"false"},this._config.wasmKernelConfig);Object.keys(t).forEach((function(i){e.fakeVideoElement.setAttribute(i,t[i])})),this.fakeVideoElement.style.position="absolute",this.fakeVideoElement.style.width="100%",this.fakeVideoElement.style.height="100%",this.fakeVideoElement.style.top="0",this.fakeVideoElement.style.left="0"}return this.fakeVideoElement},t.prototype.parseErrorData=function(){var e=this._video.error,t=(e||{}).code,i=[n.ERROR_CODE.NOT_SUPPROT,n.ERROR_CODE.LOAD_IFRAME,n.ERROR_CODE.LOAD_WASM,n.ERROR_CODE.LOAD_WASM_MAIN_SCRIPT,n.ERROR_CODE.LOAD_WASM_SPWAN_WORKER_SCRIPT];return t===n.ERROR_CODE.NOT_SUPPROT&&(a.a.isEnvSupport=!1),l(l({},e),{fatal:-1!==i.indexOf(t)})},t.prototype.triggerAutoplay=function(){return Promise.resolve()},t.prototype.load=function(e,t){var i,r;if(this._logger.log("load()"),!e.loadingUrl)return!1;s.videoTool.clear(this._video),this.stopInner(!0),this._videoInfo=e,this._videoInfo.extraVars.isLoadstarted=!0,this.setVideoEvents(!0),this.stateMgr.setLoadStart();var n=(t||{}).startTime;Number.isNaN(n)&&(this._logger.warn("load(), startTime isNaN!"),n=0);var a=this._videoInfo,o=a.config,l=a.loadingUrl,u=o.m3u8,h=void 0===u?{}:u,d=o.chachaParam,c={url:l,m3u8Str:(null===(r=(i=this.config.wasmKernelConfig).lookupCache)||void 0===r?void 0:r.call(i,l))||h[l],startTimeMs:1e3*n,type:this._config.type,decConfig:d};return this._userStartTime=n,this._video.srcConfig=c,this._video.load(),!0},t.prototype.play=function(e,t){return this._logger.log("play(), uid/idx/state: ".concat(e?e.uid:"","/").concat(this.idx,"/").concat(this.state)),this._played=!0,e&&(e.extraVars.isLoadstarted||this.load(e,t)),this.setMainLoopEnable(!0),this.videoplay()},t.prototype.seek=function(e,t){return void 0===t&&(t=!1),this._logger.log("seek()"),this._isUserSeek=t,this._targetSeekTime=e,this._video.currentTime=e,!0},t.prototype.destroy=function(){var t,i;e.prototype.destroy.call(this),(null===(t=this.interactDom)||void 0===t?void 0:t.parentNode)&&this.interactDom.remove(),null===(i=this.fakeVideoElement)||void 0===i||i.destroy()},t}(s.BaseVideoNode)},function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r,s=i(0),n=i(5),a=(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),o=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return a(t,e),Object.defineProperty(t.prototype,"kernelName",{get:function(){return s.KERNEL_NAME.WASM},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"supportPlaybackRate",{get:function(){return!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"supportPreload",{get:function(){return!1},enumerable:!1,configurable:!0}),t.prototype.createVideoNode=function(e){return new n.a(e)},t.prototype.setVideoOpacity=function(){},t.prototype.setVideoElementState=function(e,t){e.volume=t?this._volume:0},t}(s.MultiPlayer)},function(e,t,i){"use strict";i.d(t,"a",(function(){return u}));var r=i(0),s=i(1),n=i(3),a=i(4),o=i(6),l=function(){return(l=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var s in t=arguments[i])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)},u=function(){function e(e){return e.maxVideoNodeCount=1,e.wasmKernelConfig=l(l(l({},s.fakeVideoDefaultConfig),e.wasmKernelConfig),{featType:"min"}),(null==e?void 0:e.type)===r.PLAY_MODE.LIVE?new a.a(e):new o.a(e)}return e.isEnvSupport=Object(n.a)(),e.canPlayType=["hls","mp4"],e}()},function(e,t,i){"use strict";i.r(t),i.d(t,"BUILD_TIME",(function(){return l})),i.d(t,"VERSION",(function(){return u}));var r=i(0),s=i(2),n=i(1);for(var a in n)["default","BUILD_TIME","VERSION","WasmPlayerMin"].indexOf(a)<0&&function(e){i.d(t,e,(function(){return n[e]}))}(a);var o=i(7);i.d(t,"WasmPlayerMin",(function(){return o.a})),r.KernelFactory.registerKernel(r.KERNEL_NAME.WASM,s.a);var l=1714385519128,u="1.32.11"}]);